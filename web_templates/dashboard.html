{% extends "base.html" %}

{% block title %}Dashboard - Crypto Tax Generator{% endblock %}

{% block extra_css %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, var(--md-sys-color-primary) 0%, var(--md-sys-color-secondary) 100%);
        color: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 8px 0;
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .action-buttons {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 24px;
    }
</style>
{% endblock %}

{% block content %}
<h1 style="margin-bottom: 24px;">Dashboard</h1>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Total Transactions</div>
        <div class="stat-value" id="totalTransactions">-</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">Unique Coins</div>
        <div class="stat-value" id="uniqueCoins">-</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">Warnings</div>
        <div class="stat-value" id="totalWarnings">-</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">Reports Generated</div>
        <div class="stat-value" id="totalReports">-</div>
    </div>
</div>

<div class="card">
    <h2 class="card-title">Quick Actions</h2>
    <div class="action-buttons">
        <button class="btn btn-primary" id="btnRunTax">
            <span class="material-icons" style="vertical-align: middle;">play_arrow</span>
            Run Tax Calculation
        </button>
        <button class="btn btn-secondary" id="diagnosticsBtn" onclick="openDiagnostics()">
            <span class="material-icons" style="vertical-align: middle;">build</span>
            Diagnose & Fix
        </button>
        <button class="btn btn-secondary" id="btnViewTransactions">
            <span class="material-icons" style="vertical-align: middle;">list</span>
            View Transactions
        </button>
        <button class="btn btn-secondary" id="btnCheckWarnings">
            <span class="material-icons" style="vertical-align: middle;">warning</span>
            Check Warnings
        </button>
        <button class="btn btn-secondary" id="btnDownloadReports">
            <span class="material-icons" style="vertical-align: middle;">download</span>
            Download Reports
        </button>
    </div>
</div>

<div class="card">
    <h2 class="card-title">System Status</h2>
    <div id="systemStatus">
        <p>Loading status...</p>
    </div>
</div>

<div class="card">
    <h2 class="card-title">Recent Activity</h2>
    <div id="recentActivity">
        <p>Loading recent transactions...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script nonce="{{ csp_nonce }}">
    async function loadDashboardData() {
        try {
            // First, run system health check on login
            await runHealthCheck();
            
            // Load statistics
            const statsResponse = await api.get('/api/stats');
            const stats = JSON.parse(statsResponse.data);
            
            document.getElementById('totalTransactions').textContent = stats.total_transactions ? stats.total_transactions.toLocaleString() : '0';
            document.getElementById('uniqueCoins').textContent = stats.top_coins ? Object.keys(stats.top_coins).length : '0';
            
            // Load warnings
            try {
                const warningsResponse = await api.get('/api/warnings');
                const warnings = JSON.parse(warningsResponse.data);
                document.getElementById('totalWarnings').textContent = warnings.warnings ? warnings.warnings.length : '0';
            } catch (e) {
                document.getElementById('totalWarnings').textContent = '0';
            }
            
            // Load reports
            try {
                const reportsResponse = await api.get('/api/reports');
                const reports = JSON.parse(reportsResponse.data);
                let totalReports = 0;
                if (reports && Array.isArray(reports)) {
                    reports.forEach(year => totalReports += year.reports ? year.reports.length : 0);
                }
                document.getElementById('totalReports').textContent = totalReports;
            } catch (e) {
                document.getElementById('totalReports').textContent = '0';
            }
            
            // Update system status with AI/ML mode
            const dbExists = await checkDatabaseExists();
            let aiMode = 'Unknown';
            try {
                const configResp = await api.get('/api/config');
                const config = typeof configResp.data === 'string' ? JSON.parse(configResp.data) : configResp.data;
                if (config.accuracy_mode && config.accuracy_mode.enabled) {
                    aiMode = 'Accuracy Mode';
                } else if (config.ml_fallback && config.ml_fallback.enabled) {
                    aiMode = (config.ml_fallback.model_name === 'gemma') ? 'ML Fallback (Gemma)' : 'ML Fallback (Shim)';
                } else {
                    aiMode = 'None (Rules Only)';
                }
            } catch (e) {
                aiMode = 'Unknown';
            }
            document.getElementById('systemStatus').innerHTML = `
                <p><strong>Database:</strong> ${dbExists ? 'Connected ‚úì' : 'Not found - Run setup'}</p>
                <p><strong>Date Range:</strong> ${stats.date_range && stats.date_range.min ? stats.date_range.min + ' to ' + stats.date_range.max : 'No data yet'}</p>
                <p><strong>Encryption:</strong> Active üîí</p>
                <p><strong>HTTPS:</strong> Enabled ‚úì</p>
                <p><strong>AI/ML Mode:</strong> <span id="aiModeStatus">${aiMode}</span></p>
            `;
            
            // Update recent activity
            if (stats.total_transactions > 0) {
                document.getElementById('recentActivity').innerHTML = `
                    <p>You have ${stats.total_transactions} transactions in the database.</p>
                    <p><a href="/transactions">View all transactions ‚Üí</a></p>
                `;
            } else {
                document.getElementById('recentActivity').innerHTML = `
                    <p style="color: var(--md-sys-color-on-surface-variant);">
                        No transactions yet. Upload CSV files or connect exchange APIs to get started.
                    </p>
                `;
            }
            
        } catch (error) {
            console.error('Error loading dashboard:', error);
            document.getElementById('systemStatus').innerHTML = `
                <p style="color: var(--md-sys-color-error);">Failed to load system status.</p>
                <p>Error: ${error.message}</p>
            `;
            document.getElementById('recentActivity').innerHTML = `
                <p style="color: var(--md-sys-color-error);">Failed to load recent activity.</p>
            `;
            
            // Set default values
            document.getElementById('totalTransactions').textContent = '-';
            document.getElementById('uniqueCoins').textContent = '-';
            document.getElementById('totalWarnings').textContent = '-';
            document.getElementById('totalReports').textContent = '-';
        }
    }
    
    async function checkDatabaseExists() {
        try {
            const response = await api.get('/api/stats');
            return true;
        } catch {
            return false;
        }
    }
    
    async function runHealthCheck() {
        try {
            const health = await api.get('/api/system-health');
            
            // Display health check results
            let hasErrors = false;
            let hasWarnings = false;
            
            for (const check of health.checks) {
                if (check.status === 'ERROR') {
                    hasErrors = true;
                    showAlert(`‚ùå ${check.name}: ${check.message}`, 'error');
                } else if (check.status === 'WARNING') {
                    hasWarnings = true;
                    showAlert(`‚ö†Ô∏è ${check.name}: ${check.message}`, 'warning');
                }
            }
            
            // Show success message if everything is OK
            if (!hasErrors && !hasWarnings) {
                showAlert('‚úÖ System Health Check: All systems operational', 'success');
            } else if (hasErrors) {
                showAlert('‚ùå System Health Check: Critical errors detected. Please review above.', 'error');
            } else if (hasWarnings) {
                showAlert('‚ö†Ô∏è System Health Check: Warnings detected. System functional but review recommended.', 'warning');
            }
            
            // Log full health status to console
            console.log('System Health Check:', health);
            
        } catch (error) {
            showAlert('‚ö†Ô∏è Failed to run system health check: ' + error.message, 'warning');
        }
    }
    
    async function runTaxCalculation() {
        if (!confirm('Start tax calculation? This may take several minutes.')) {
            return;
        }
        
        try {
            const response = await api.post('/api/run', {});
            const result = JSON.parse(response.data);
            
            // Start tracking progress
            if (result.task_id) {
                progressTracker.trackTask(result.task_id, 'Running Tax Calculation');
            } else {
                showAlert(result.message, 'success');
            }
        } catch (error) {
            showAlert('Failed to start calculation: ' + error.message, 'error');
        }
    }

        async function openDiagnostics() {
            try {
                const diag = await apiClient.get('/api/diagnostics');
                const issues = diag.issues || [];
                const modal = document.getElementById('diagnosticsModal');
                const list = document.getElementById('diagnosticsList');
                list.innerHTML = '';
                if (issues.length === 0) {
                    list.innerHTML = '<li>‚úÖ No issues detected</li>';
                } else {
                    for (const it of issues) {
                        const li = document.createElement('li');
                        li.textContent = `${it.severity.toUpperCase()}: ${it.message}`;
                        if (it.fix && it.fix.action === 'unlock_db') {
                            const input = document.createElement('input');
                            input.type = 'password';
                            input.placeholder = 'Enter web password to unlock';
                            input.style.marginLeft = '8px';
                            const btn = document.createElement('button');
                            btn.textContent = 'Unlock';
                            btn.style.marginLeft = '8px';
                            btn.onclick = async () => {
                                const res = await apiClient.post('/api/diagnostics/unlock', { password: input.value });
                                alert(res.message || 'Unlock attempt complete');
                                modal.classList.remove('open');
                            };
                            li.appendChild(input);
                            li.appendChild(btn);
                        } else if (it.fix && it.fix.action === 'schema_check') {
                            const btn = document.createElement('button');
                            btn.textContent = 'Run Integrity Check';
                            btn.style.marginLeft = '8px';
                            btn.onclick = async () => {
                                const res = await apiClient.get(it.fix.endpoint || '/api/diagnostics/schema-check');
                                alert(`Schema status: ${res.status} (ok=${res.ok})`);
                            };
                            li.appendChild(btn);
                        } else if (it.fix && it.fix.action === 'auto_generate_on_start') {
                            const btn = document.createElement('button');
                            btn.textContent = 'Generate Cert';
                            btn.style.marginLeft = '8px';
                            btn.onclick = async () => {
                                const res = await apiClient.post('/api/diagnostics/generate-cert', {});
                                alert(res.message || 'Certificate generated');
                                modal.classList.remove('open');
                            };
                            li.appendChild(btn);
                        }
                        list.appendChild(li);
                    }
                }
                modal.classList.add('open');
            } catch (e) {
                alert('Diagnostics failed: ' + e.message);
            }
        }

        function closeDiagnostics() {
            const modal = document.getElementById('diagnosticsModal');
            modal.classList.remove('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Populate system status with last diagnostics
            (async () => {
                try {
                    const diag = await apiClient.get('/api/diagnostics/last');
                    const box = document.getElementById('systemStatus');
                    const issues = diag.issues || [];
                const statusItems = diag.status || [];
                box.innerHTML = '';
                
                // Show positive status items first
                if (statusItems.length > 0) {
                    const statusDiv = document.createElement('div');
                    statusDiv.style.marginBottom = '12px';
                    const statusList = document.createElement('ul');
                    statusList.className = 'plain-list status-ok-list';
                    for (const st of statusItems) {
                        const li = document.createElement('li');
                        li.innerHTML = `<span class="status-icon">${st.icon}</span> ${st.message}`;
                        statusList.appendChild(li);
                    }
                    statusDiv.appendChild(statusList);
                    box.appendChild(statusDiv);
                }
                
                // Show issues if any
                if (issues.length > 0) {
                    const summary = document.createElement('div');
                    summary.style.marginBottom = '8px';
                    summary.style.marginTop = '12px';
                    summary.style.fontWeight = 'bold';
                    const counts = {error:0, warning:0, info:0};
                    for (const it of issues) { if (counts[it.severity] !== undefined) counts[it.severity]++; }
                    summary.textContent = `Issues: Errors: ${counts.error} ‚Ä¢ Warnings: ${counts.warning} ‚Ä¢ Info: ${counts.info}`;
                    box.appendChild(summary);
                    const ul = document.createElement('ul');
                    ul.className = 'plain-list';
                    for (const it of issues) {
                        const li = document.createElement('li');
                        li.textContent = `${it.severity.toUpperCase()}: ${it.message}`;
                        ul.appendChild(li);
                    }
                    box.appendChild(ul);
                } else if (statusItems.length > 0) {
                    const allGood = document.createElement('div');
                    allGood.style.marginTop = '12px';
                    allGood.style.color = 'var(--md-sys-color-tertiary)';
                    allGood.style.fontWeight = 'bold';
                    allGood.textContent = '‚úÖ No issues detected';
                    box.appendChild(allGood);
                }
            const diagnosticsModal = document.createElement('div');
            diagnosticsModal.id = 'diagnosticsModal';
            diagnosticsModal.className = 'simple-modal';
            diagnosticsModal.innerHTML = `
                <div class="simple-modal-content">
                    <h3>Diagnostics & Fixes</h3>
                    <ul id="diagnosticsList" class="plain-list"></ul>
                    <div style="text-align:right;margin-top:12px;">
                        <button class="md-button" onclick="closeDiagnostics()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(diagnosticsModal);
        });

        <style>
            .simple-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; }
            .simple-modal.open { display: flex; align-items: center; justify-content: center; }
            .simple-modal-content { background: var(--md-sys-color-surface); color: var(--md-sys-color-on-surface); border-radius: 12px; padding: 16px; width: 520px; max-width: 92vw; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
            .plain-list { list-style: none; padding: 0; margin: 0; }
            .plain-list li { padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.08); }
        .status-ok-list li { border-bottom: none; padding: 6px 0; color: var(--md-sys-color-on-surface); }
        .status-icon { font-size: 1.2em; margin-right: 8px; vertical-align: middle; }
        loadDashboardData();
        
        const btnRunTax = document.getElementById('btnRunTax');
        if (btnRunTax) btnRunTax.addEventListener('click', runTaxCalculation);
        
        const btnViewTransactions = document.getElementById('btnViewTransactions');
        if (btnViewTransactions) btnViewTransactions.addEventListener('click', () => window.location.href='/transactions');
        
        const btnCheckWarnings = document.getElementById('btnCheckWarnings');
        if (btnCheckWarnings) btnCheckWarnings.addEventListener('click', () => window.location.href='/warnings');
        
        const btnDownloadReports = document.getElementById('btnDownloadReports');
        if (btnDownloadReports) btnDownloadReports.addEventListener('click', () => window.location.href='/reports');
    });
</script>
{% endblock %}
