{% extends "base.html" %}

{% block title %}Dashboard - Crypto Tax Generator{% endblock %}

{% block extra_css %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, var(--md-sys-color-primary) 0%, var(--md-sys-color-secondary) 100%);
        color: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 8px 0;
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .action-buttons {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 24px;
    }
</style>
{% endblock %}

{% block content %}
<h1 style="margin-bottom: 24px;">Dashboard</h1>

<!-- Security Incident Warning Banner -->
<div id="security-alert-banner" style="display: none; background: linear-gradient(135deg, #ef5350 0%, #f44336 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">
    <div style="display: flex; align-items: center; justify-content: space-between;">
        <div style="flex: 1;">
            <h2 style="margin: 0 0 10px 0; font-size: 20px;">
                <span class="material-icons" style="vertical-align: middle; font-size: 24px;">warning</span>
                Security Incident Detected
            </h2>
            <p id="alert-message" style="margin: 0 0 10px 0; opacity: 0.95;">The system has detected suspicious activity and operations may be restricted.</p>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <span id="critical-count" style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">üî¥ 0 Critical</span>
                <span id="high-count" style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">üü† 0 High</span>
                <span id="lock-status" style="background: rgba(255,255,255,0.3); padding: 6px 12px; border-radius: 20px; font-size: 14px; font-weight: 600; display: none;">üîí Operations Locked</span>
            </div>
        </div>
        <div>
            <button class="btn" onclick="window.location.href='/audit-responses'" style="background: white; color: #f44336; font-weight: 600;">
                View Incident Dashboard
            </button>
        </div>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Total Transactions</div>
        <div class="stat-value" id="totalTransactions">-</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">Unique Coins</div>
        <div class="stat-value" id="uniqueCoins">-</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">Warnings</div>
        <div class="stat-value" id="totalWarnings">-</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">Reports Generated</div>
        <div class="stat-value" id="totalReports">-</div>
    </div>
</div>

<div class="card">
    <h2 class="card-title">Quick Actions</h2>
    <div class="action-buttons">
        <button class="btn btn-primary" id="btnRunTax">
            <span class="material-icons" style="vertical-align: middle;">play_arrow</span>
            Run Tax Calculation
        </button>
        <button class="btn btn-secondary" id="diagnosticsBtn" onclick="openDiagnostics()">
            <span class="material-icons" style="vertical-align: middle;">build</span>
            Diagnose & Fix
        </button>
        <button class="btn btn-secondary" id="btnViewTransactions">
            <span class="material-icons" style="vertical-align: middle;">list</span>
            View Transactions
        </button>
        <button class="btn btn-secondary" id="btnCheckWarnings">
            <span class="material-icons" style="vertical-align: middle;">warning</span>
            Check Warnings
        </button>
        <button class="btn btn-secondary" id="btnDownloadReports">
            <span class="material-icons" style="vertical-align: middle;">download</span>
            Download Reports
        </button>
    </div>
</div>

<div class="card">
    <h2 class="card-title">System Status</h2>
    <div id="systemStatus">
        <p>Loading status...</p>
    </div>
</div>

<div class="card">
    <h2 class="card-title">Audit System Integrity</h2>
    <div id="auditIntegrityWidget" style="margin-top: 16px;">
        <!-- Integrity Score Meter -->
        <div style="margin-bottom: 20px;">
            <p style="margin-bottom: 8px;"><strong>System Integrity Score</strong></p>
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="flex: 1; height: 24px; background: #e0e0e0; border-radius: 12px; overflow: hidden;">
                    <div id="integrityMeter" style="height: 100%; background: linear-gradient(90deg, #4caf50, #8bc34a); width: 95%; transition: width 0.3s ease;"></div>
                </div>
                <span id="integrityScore" style="font-weight: 700; min-width: 50px;">95%</span>
            </div>
            <p id="integrityStatus" style="margin-top: 8px; font-size: 0.9rem; color: #4caf50;">‚úì HEALTHY</p>
        </div>

        <!-- Recent Anomalies -->
        <div style="margin-bottom: 20px;">
            <p style="margin-bottom: 8px;"><strong>Recent Anomalies</strong></p>
            <div id="recentAnomalies" style="max-height: 200px; overflow-y: auto; background: #f5f5f5; border-radius: 8px; padding: 12px;">
                <p style="color: #999; font-size: 0.9rem;">Loading...</p>
            </div>
        </div>

        <!-- Last Audit Check -->
        <div style="margin-bottom: 20px;">
            <p style="margin-bottom: 8px;"><strong>Last Audit Check</strong></p>
            <p id="lastAuditCheck" style="font-size: 0.9rem; color: #666;">Never</p>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="btn btn-primary" id="runAuditBtn" style="font-size: 0.9rem;">
                <span class="material-icons" style="font-size: 1rem; vertical-align: middle;">refresh</span>
                Run Audit Check
            </button>
            <button class="btn btn-secondary" id="viewAuditDetailsBtn" style="font-size: 0.9rem;">
                <span class="material-icons" style="font-size: 1rem; vertical-align: middle;">info</span>
                View Details
            </button>
            <button class="btn btn-secondary" id="downloadAuditReportBtn" style="font-size: 0.9rem;">
                <span class="material-icons" style="font-size: 1rem; vertical-align: middle;">download</span>
                Download Report
            </button>
        </div>
    </div>
</div>

<div class="card">
    <h2 class="card-title">Audit Log Signature Verification</h2>
    <div id="signatureVerificationWidget" style="margin-top: 16px;">
        <!-- Verification Summary -->
        <div style="margin-bottom: 20px;">
            <p style="margin-bottom: 8px;"><strong>Signature Status</strong></p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div style="padding: 12px; background: #f5f5f5; border-radius: 8px; border-left: 4px solid #4caf50;">
                    <p style="margin: 0; font-size: 0.85rem; color: #666;">Valid Signatures</p>
                    <p id="validSignatureCount" style="margin: 8px 0 0 0; font-size: 1.5rem; font-weight: 700; color: #4caf50;">‚Äî</p>
                </div>
                <div style="padding: 12px; background: #f5f5f5; border-radius: 8px; border-left: 4px solid #ff9800;">
                    <p style="margin: 0; font-size: 0.85rem; color: #666;">Invalid/Missing Signatures</p>
                    <p id="invalidSignatureCount" style="margin: 8px 0 0 0; font-size: 1.5rem; font-weight: 700; color: #ff9800;">‚Äî</p>
                </div>
            </div>
        </div>

        <!-- Invalid Entries List -->
        <div style="margin-bottom: 20px;">
            <p style="margin-bottom: 8px;"><strong>‚ö†Ô∏è Invalid/Unsigned Entries</strong></p>
            <div id="invalidSignatureEntries" style="max-height: 250px; overflow-y: auto; background: #fff3e0; border: 1px solid #ffcc80; border-radius: 8px; padding: 12px;">
                <p style="color: #999; font-size: 0.9rem;">Loading verification results...</p>
            </div>
        </div>

        <!-- Verification Controls -->
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="btn btn-primary" id="verifySignaturesBtn" style="font-size: 0.9rem;">
                <span class="material-icons" style="font-size: 1rem; vertical-align: middle;">verified_user</span>
                Verify All Signatures
            </button>
            <button class="btn btn-secondary" id="signatureStatsBtn" style="font-size: 0.9rem;">
                <span class="material-icons" style="font-size: 1rem; vertical-align: middle;">bar_chart</span>
                View Statistics
            </button>
        </div>
    </div>
</div>

<div class="card">
    <h2 class="card-title">Recent Activity</h2>
    <div id="recentActivity">
        <p>Loading recent transactions...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script nonce="{{ csp_nonce }}">
    async function loadDashboardData() {
        try {
            // First, run system health check on login
            await runHealthCheck();
            
            // Load statistics
            const statsResponse = await api.get('/api/stats');
            const stats = JSON.parse(statsResponse.data);
            
            document.getElementById('totalTransactions').textContent = stats.total_transactions ? stats.total_transactions.toLocaleString() : '0';
            document.getElementById('uniqueCoins').textContent = stats.top_coins ? Object.keys(stats.top_coins).length : '0';
            
            // Load warnings
            try {
                const warningsResponse = await api.get('/api/warnings');
                const warnings = JSON.parse(warningsResponse.data);
                document.getElementById('totalWarnings').textContent = warnings.warnings ? warnings.warnings.length : '0';
            } catch (e) {
                document.getElementById('totalWarnings').textContent = '0';
            }
            
            // Load reports
            try {
                const reportsResponse = await api.get('/api/reports');
                const reports = JSON.parse(reportsResponse.data);
                let totalReports = 0;
                if (reports && Array.isArray(reports)) {
                    reports.forEach(year => totalReports += year.reports ? year.reports.length : 0);
                }
                document.getElementById('totalReports').textContent = totalReports;
            } catch (e) {
                document.getElementById('totalReports').textContent = '0';
            }
            
            // Update system status with AI/ML mode
            const dbExists = await checkDatabaseExists();
            let aiMode = 'Unknown';
            try {
                const configResp = await api.get('/api/config');
                const config = typeof configResp.data === 'string' ? JSON.parse(configResp.data) : configResp.data;
                if (config.accuracy_mode && config.accuracy_mode.enabled) {
                    aiMode = 'Accuracy Mode';
                } else if (config.ml_fallback && config.ml_fallback.enabled) {
                    aiMode = (config.ml_fallback.model_name === 'gemma') ? 'ML Fallback (Gemma)' : 'ML Fallback (Shim)';
                } else {
                    aiMode = 'None (Rules Only)';
                }
            } catch (e) {
                aiMode = 'Unknown';
            }
            document.getElementById('systemStatus').innerHTML = `
                <p><strong>Database:</strong> ${dbExists ? 'Connected ‚úì' : 'Not found - Run setup'}</p>
                <p><strong>Date Range:</strong> ${stats.date_range && stats.date_range.min ? stats.date_range.min + ' to ' + stats.date_range.max : 'No data yet'}</p>
                <p><strong>Encryption:</strong> Active üîí</p>
                <p><strong>HTTPS:</strong> Enabled ‚úì</p>
                <p><strong>AI/ML Mode:</strong> <span id="aiModeStatus">${aiMode}</span></p>
            `;
            
            // Update recent activity
            if (stats.total_transactions > 0) {
                document.getElementById('recentActivity').innerHTML = `
                    <p>You have ${stats.total_transactions} transactions in the database.</p>
                    <p><a href="/transactions">View all transactions ‚Üí</a></p>
                `;
            } else {
                document.getElementById('recentActivity').innerHTML = `
                    <p style="color: var(--md-sys-color-on-surface-variant);">
                        No transactions yet. Upload CSV files or connect exchange APIs to get started.
                    </p>
                `;
            }
            
        } catch (error) {
            console.error('Error loading dashboard:', error);
            document.getElementById('systemStatus').innerHTML = `
                <p style="color: var(--md-sys-color-error);">Failed to load system status.</p>
                <p>Error: ${error.message}</p>
            `;
            document.getElementById('recentActivity').innerHTML = `
                <p style="color: var(--md-sys-color-error);">Failed to load recent activity.</p>
            `;
            
            // Set default values
            document.getElementById('totalTransactions').textContent = '-';
            document.getElementById('uniqueCoins').textContent = '-';
            document.getElementById('totalWarnings').textContent = '-';
            document.getElementById('totalReports').textContent = '-';
        }
    }
    
    async function checkDatabaseExists() {
        try {
            const response = await api.get('/api/stats');
            return true;
        } catch {
            return false;
        }
    }
    
    async function runHealthCheck() {
        try {
            const health = await api.get('/api/system-health');
            
            // Display health check results
            let hasErrors = false;
            let hasWarnings = false;
            
            for (const check of health.checks) {
                if (check.status === 'ERROR') {
                    hasErrors = true;
                    showAlert(`‚ùå ${check.name}: ${check.message}`, 'error');
                } else if (check.status === 'WARNING') {
                    hasWarnings = true;
                    showAlert(`‚ö†Ô∏è ${check.name}: ${check.message}`, 'warning');
                }
            }
            
            // Show success message if everything is OK
            if (!hasErrors && !hasWarnings) {
                showAlert('‚úÖ System Health Check: All systems operational', 'success');
            } else if (hasErrors) {
                showAlert('‚ùå System Health Check: Critical errors detected. Please review above.', 'error');
            } else if (hasWarnings) {
                showAlert('‚ö†Ô∏è System Health Check: Warnings detected. System functional but review recommended.', 'warning');
            }
            
            // Log full health status to console
            console.log('System Health Check:', health);
            
        } catch (error) {
            showAlert('‚ö†Ô∏è Failed to run system health check: ' + error.message, 'warning');
        }
    }
    
    async function runTaxCalculation() {
        if (!confirm('Start tax calculation? This may take several minutes.')) {
            return;
        }
        
        try {
            const response = await api.post('/api/run', {});
            const result = JSON.parse(response.data);
            
            // Start tracking progress
            if (result.task_id) {
                progressTracker.trackTask(result.task_id, 'Running Tax Calculation');
            } else {
                showAlert(result.message, 'success');
            }
        } catch (error) {
            showAlert('Failed to start calculation: ' + error.message, 'error');
        }
    }

        async function openDiagnostics() {
            try {
                const diag = await apiClient.get('/api/diagnostics');
                const issues = diag.issues || [];
                const modal = document.getElementById('diagnosticsModal');
                const list = document.getElementById('diagnosticsList');
                list.innerHTML = '';
                if (issues.length === 0) {
                    list.innerHTML = '<li>‚úÖ No issues detected</li>';
                } else {
                    for (const it of issues) {
                        const li = document.createElement('li');
                        li.textContent = `${it.severity.toUpperCase()}: ${it.message}`;
                        if (it.fix && it.fix.action === 'unlock_db') {
                            const input = document.createElement('input');
                            input.type = 'password';
                            input.placeholder = 'Enter web password to unlock';
                            input.style.marginLeft = '8px';
                            const btn = document.createElement('button');
                            btn.textContent = 'Unlock';
                            btn.style.marginLeft = '8px';
                            btn.onclick = async () => {
                                const res = await apiClient.post('/api/diagnostics/unlock', { password: input.value });
                                alert(res.message || 'Unlock attempt complete');
                                modal.classList.remove('open');
                            };
                            li.appendChild(input);
                            li.appendChild(btn);
                        } else if (it.fix && it.fix.action === 'schema_check') {
                            const btn = document.createElement('button');
                            btn.textContent = 'Run Integrity Check';
                            btn.style.marginLeft = '8px';
                            btn.onclick = async () => {
                                const res = await apiClient.get(it.fix.endpoint || '/api/diagnostics/schema-check');
                                alert(`Schema status: ${res.status} (ok=${res.ok})`);
                            };
                            li.appendChild(btn);
                        } else if (it.fix && it.fix.action === 'auto_generate_on_start') {
                            const btn = document.createElement('button');
                            btn.textContent = 'Generate Cert';
                            btn.style.marginLeft = '8px';
                            btn.onclick = async () => {
                                const res = await apiClient.post('/api/diagnostics/generate-cert', {});
                                alert(res.message || 'Certificate generated');
                                modal.classList.remove('open');
                            };
                            li.appendChild(btn);
                        }
                        list.appendChild(li);
                    }
                }
                modal.classList.add('open');
            } catch (e) {
                alert('Diagnostics failed: ' + e.message);
            }
        }

        function closeDiagnostics() {
            const modal = document.getElementById('diagnosticsModal');
            modal.classList.remove('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Populate system status with last diagnostics
            (async () => {
                try {
                    const diag = await apiClient.get('/api/diagnostics/last');
                    const box = document.getElementById('systemStatus');
                    const issues = diag.issues || [];
                const statusItems = diag.status || [];
                box.innerHTML = '';
                
                // Show positive status items first
                if (statusItems.length > 0) {
                    const statusDiv = document.createElement('div');
                    statusDiv.style.marginBottom = '12px';
                    const statusList = document.createElement('ul');
                    statusList.className = 'plain-list status-ok-list';
                    for (const st of statusItems) {
                        const li = document.createElement('li');
                        li.innerHTML = `<span class="status-icon">${st.icon}</span> ${st.message}`;
                        statusList.appendChild(li);
                    }
                    statusDiv.appendChild(statusList);
                    box.appendChild(statusDiv);
                }
                
                // Show issues if any
                if (issues.length > 0) {
                    const summary = document.createElement('div');
                    summary.style.marginBottom = '8px';
                    summary.style.marginTop = '12px';
                    summary.style.fontWeight = 'bold';
                    const counts = {error:0, warning:0, info:0};
                    for (const it of issues) { if (counts[it.severity] !== undefined) counts[it.severity]++; }
                    summary.textContent = `Issues: Errors: ${counts.error} ‚Ä¢ Warnings: ${counts.warning} ‚Ä¢ Info: ${counts.info}`;
                    box.appendChild(summary);
                    const ul = document.createElement('ul');
                    ul.className = 'plain-list';
                    for (const it of issues) {
                        const li = document.createElement('li');
                        li.textContent = `${it.severity.toUpperCase()}: ${it.message}`;
                        ul.appendChild(li);
                    }
                    box.appendChild(ul);
                } else if (statusItems.length > 0) {
                    const allGood = document.createElement('div');
                    allGood.style.marginTop = '12px';
                    allGood.style.color = 'var(--md-sys-color-tertiary)';
                    allGood.style.fontWeight = 'bold';
                    allGood.textContent = '‚úÖ No issues detected';
                    box.appendChild(allGood);
                }
            const diagnosticsModal = document.createElement('div');
            diagnosticsModal.id = 'diagnosticsModal';
            diagnosticsModal.className = 'simple-modal';
            diagnosticsModal.innerHTML = `
                <div class="simple-modal-content">
                    <h3>Diagnostics & Fixes</h3>
                    <ul id="diagnosticsList" class="plain-list"></ul>
                    <div style="text-align:right;margin-top:12px;">
                        <button class="md-button" onclick="closeDiagnostics()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(diagnosticsModal);
        });

        <style>
            .simple-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; }
            .simple-modal.open { display: flex; align-items: center; justify-content: center; }
            .simple-modal-content { background: var(--md-sys-color-surface); color: var(--md-sys-color-on-surface); border-radius: 12px; padding: 16px; width: 520px; max-width: 92vw; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
            .plain-list { list-style: none; padding: 0; margin: 0; }
            .plain-list li { padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.08); }
        .status-ok-list li { border-bottom: none; padding: 6px 0; color: var(--md-sys-color-on-surface); }
        .status-icon { font-size: 1.2em; margin-right: 8px; vertical-align: middle; }
        async function loadAuditIntegrity() {
        try {
            const response = await api.get('/api/audit-dashboard-data');
            const data = JSON.parse(response.data);
            
            // Update integrity score meter
            const score = data.integrity_score || 0;
            const scorePercent = Math.round(score * 100);
            document.getElementById('integrityScore').textContent = scorePercent + '%';
            document.getElementById('integrityMeter').style.width = (scorePercent) + '%';
            
            // Update status and color based on score
            const statusEl = document.getElementById('integrityStatus');
            if (score >= 0.9) {
                statusEl.innerHTML = '‚úì HEALTHY';
                statusEl.style.color = '#4caf50';
                document.getElementById('integrityMeter').style.background = 'linear-gradient(90deg, #4caf50, #8bc34a)';
            } else if (score >= 0.7) {
                statusEl.innerHTML = '‚ö† CONCERNS';
                statusEl.style.color = '#ff9800';
                document.getElementById('integrityMeter').style.background = 'linear-gradient(90deg, #ff9800, #ffc107)';
            } else {
                statusEl.innerHTML = '‚ö†Ô∏è COMPROMISED';
                statusEl.style.color = '#f44336';
                document.getElementById('integrityMeter').style.background = 'linear-gradient(90deg, #f44336, #e91e63)';
            }
            
            // Update recent anomalies
            const anomaliesContainer = document.getElementById('recentAnomalies');
            if (data.anomalies && data.anomalies.length > 0) {
                anomaliesContainer.innerHTML = data.anomalies.slice(0, 5).map(a => `
                    <div style="padding: 8px; border-bottom: 1px solid #ddd;">
                        <strong>${a.type || 'Unknown'}</strong> - <span style="color: ${
                            a.severity === 'CRITICAL' ? '#f44336' : 
                            a.severity === 'HIGH' ? '#ff9800' : '#ffc107'
                        };">${a.severity || 'UNKNOWN'}</span>
                        <div style="font-size: 0.85rem; color: #666; margin-top: 4px;">${a.description || 'No details'}</div>
                    </div>
                `).join('');
            } else {
                anomaliesContainer.innerHTML = '<p style="color: #999; font-size: 0.9rem; margin: 0;">No recent anomalies detected ‚úì</p>';
            }
            
            // Update last audit check timestamp
            const lastCheck = data.last_check ? new Date(data.last_check).toLocaleString() : 'Never';
            document.getElementById('lastAuditCheck').textContent = lastCheck;
            
            // Store data for details view
            window.auditData = data;
            
        } catch (error) {
            console.error('Error loading audit integrity:', error);
            document.getElementById('recentAnomalies').innerHTML = '<p style="color: #f44336;">Failed to load audit data</p>';
        }
    }
    
    async function runAuditCheck() {
        try {
            document.getElementById('runAuditBtn').disabled = true;
            document.getElementById('runAuditBtn').textContent = 'Running...';
            
            // Get recent audit logs
            const response = await api.post('/api/audit-enhancements/detect-manipulation', {
                logs: []  // API will handle getting recent logs
            });
            
            const result = JSON.parse(response.data);
            
            if (result.success || result.anomalies !== undefined) {
                showAlert('‚úì Audit check complete. Anomalies found: ' + (result.anomalies.length || 0), 'success');
                await loadAuditIntegrity();
            } else {
                showAlert('Failed to run audit check', 'error');
            }
        } catch (error) {
            showAlert('Error running audit check: ' + error.message, 'error');
        } finally {
            document.getElementById('runAuditBtn').disabled = false;
            document.getElementById('runAuditBtn').textContent = 'Run Audit Check';
        }
    }
    
    function viewAuditDetails() {
        if (!window.auditData) {
            showAlert('No audit data loaded', 'warning');
            return;
        }
        
        const data = window.auditData;
        let html = `<h3 style="margin-top: 0;">Audit System Details</h3>`;
        html += `<p><strong>Integrity Score:</strong> ${Math.round(data.integrity_score * 100)}%</p>`;
        html += `<p><strong>Status:</strong> ${data.status}</p>`;
        html += `<p><strong>Tampering Score:</strong> ${data.tampering_score}</p>`;
        html += `<p><strong>Critical Anomalies:</strong> ${data.critical_anomalies}</p>`;
        
        if (data.anomalies && data.anomalies.length > 0) {
            html += `<h4>All Anomalies (${data.anomalies.length})</h4><ul style="max-height: 300px; overflow-y: auto;">`;
            for (const a of data.anomalies) {
                html += `<li><strong>${a.type}</strong> [${a.severity}]: ${a.description}</li>`;
            }
            html += `</ul>`;
        }
        
        showModal('Audit Details', html, [
            {label: 'Close', onclick: closeModal}
        ]);
    }
    
    async function downloadAuditReport() {
        try {
            window.location.href = '/api/audit-enhancements/pdf-report?year=' + new Date().getFullYear() + '&month=' + (new Date().getMonth() + 1);
        } catch (error) {
            showAlert('Error downloading report: ' + error.message, 'error');
        }
    }

    // ===== SIGNATURE VERIFICATION FUNCTIONS =====
    
    async function loadSignatureVerification() {
        try {
            const response = await api.get('/api/audit-enhancements/verify-signatures');
            const data = JSON.parse(response.data);
            
            if (data.success) {
                // Update counts
                document.getElementById('validSignatureCount').textContent = data.valid_count || 0;
                document.getElementById('invalidSignatureCount').textContent = data.invalid_count || 0;
                
                // Display invalid entries
                const invalidList = document.getElementById('invalidSignatureEntries');
                if (data.invalid_entries && data.invalid_entries.length > 0) {
                    invalidList.innerHTML = data.invalid_entries.map(entry => `
                        <div style="padding: 8px; margin-bottom: 6px; background: #fff; border-radius: 4px; border-left: 3px solid #ff9800;">
                            <p style="margin: 0; font-size: 0.85rem; font-weight: 500;">
                                ${entry.timestamp ? new Date(entry.timestamp).toLocaleString() : 'Unknown time'}
                            </p>
                            <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #666;">
                                ${entry.action || 'Unknown action'} ${entry.status ? '(' + entry.status + ')' : ''}
                            </p>
                            <p style="margin: 4px 0 0 0; font-size: 0.75rem; color: #f57c00; font-weight: 500;">
                                ‚ö†Ô∏è ${entry.reason || 'Invalid or missing signature'}
                            </p>
                        </div>
                    `).join('');
                } else {
                    invalidList.innerHTML = '<p style="color: #4caf50; font-size: 0.9rem; margin: 0;">‚úì All entries have valid signatures</p>';
                }
                
                // Show status message
                if (data.invalid_count > 0) {
                    showAlert(`‚ö†Ô∏è Found ${data.invalid_count} invalid/unsigned entries out of ${data.valid_count + data.invalid_count} total`, 'warning');
                } else {
                    showAlert('‚úì All audit log entries have valid signatures', 'success');
                }
            } else {
                showAlert('Error: ' + (data.error || 'Verification failed'), 'error');
            }
        } catch (error) {
            showAlert('Failed to verify signatures: ' + error.message, 'error');
        }
    }

    async function verifySignatures() {
        try {
            showAlert('Verifying all audit log signatures...', 'info');
            await loadSignatureVerification();
        } catch (error) {
            showAlert('Verification error: ' + error.message, 'error');
        }
    }

    async function showSignatureStats() {
        try {
            const response = await api.get('/api/audit-enhancements/signature-stats');
            const data = JSON.parse(response.data);
            
            if (data.success && data.stats) {
                const stats = data.stats;
                const message = `
Signature Statistics:
- Total entries: ${stats.total_entries}
- Valid signatures: ${stats.valid_signatures}
- Invalid/missing: ${stats.invalid_signatures}
- Verification rate: ${((stats.valid_signatures / stats.total_entries) * 100).toFixed(1)}%
- Last verified: ${stats.last_verified ? new Date(stats.last_verified).toLocaleString() : 'Never'}`;
                showAlert(message, 'info');
            } else {
                showAlert('Could not retrieve signature statistics', 'error');
            }
        } catch (error) {
            showAlert('Error fetching statistics: ' + error.message, 'error');
        }
    }
    
    // Check for security incidents and update warning banner
    async function checkSecurityIncidents() {
        try {
            const response = await api.get('/api/audit-responses/all');
            const data = JSON.parse(response.data);
            
            if (data.success && data.incidents && data.incidents.length > 0) {
                // Show warning banner
                document.getElementById('security-alert-banner').style.display = 'block';
                
                // Count by severity
                const critical = data.incidents.filter(i => i.severity === 'CRITICAL').length;
                const high = data.incidents.filter(i => i.severity === 'HIGH').length;
                
                document.getElementById('critical-count').textContent = `üî¥ ${critical} Critical`;
                document.getElementById('high-count').textContent = `üü† ${high} High`;
                
                // Update alert message
                const total = data.incidents.length;
                document.getElementById('alert-message').textContent = 
                    `${total} security incident${total > 1 ? 's' : ''} detected. Review the incident dashboard for details.`;
            } else {
                // Hide warning banner if no incidents
                document.getElementById('security-alert-banner').style.display = 'none';
            }
            
            // Check lock status
            const lockResponse = await api.get('/api/audit-responses/lock-status');
            const lockData = JSON.parse(lockResponse.data);
            
            if (lockData.success && lockData.is_locked) {
                // Show lock status
                document.getElementById('lock-status').style.display = 'inline-block';
                document.getElementById('security-alert-banner').style.display = 'block';
                
                // Update message to reflect lock
                const lockMsg = document.getElementById('alert-message');
                lockMsg.innerHTML = `<strong>‚ö†Ô∏è OPERATIONS LOCKED</strong><br>Database operations are suspended due to security incident. Reason: ${lockData.reason || 'Unknown'}`;
            } else {
                document.getElementById('lock-status').style.display = 'none';
            }
        } catch (error) {
            console.error('Failed to check security incidents:', error);
        }
    }
    
    loadDashboardData();
    loadAuditIntegrity();
    loadSignatureVerification();  // Load signature status on page load
    checkSecurityIncidents();  // Check for security incidents
    setInterval(loadAuditIntegrity, 30000);  // Refresh audit integrity every 30 seconds
    setInterval(loadSignatureVerification, 60000);  // Refresh signatures every 60 seconds
    setInterval(checkSecurityIncidents, 5000);  // Check incidents every 5 seconds
        
        const btnRunTax = document.getElementById('btnRunTax');
        if (btnRunTax) btnRunTax.addEventListener('click', runTaxCalculation);
        
        const btnViewTransactions = document.getElementById('btnViewTransactions');
        if (btnViewTransactions) btnViewTransactions.addEventListener('click', () => window.location.href='/transactions');
        
        const btnCheckWarnings = document.getElementById('btnCheckWarnings');
        if (btnCheckWarnings) btnCheckWarnings.addEventListener('click', () => window.location.href='/warnings');
        
        const btnDownloadReports = document.getElementById('btnDownloadReports');
        if (btnDownloadReports) btnDownloadReports.addEventListener('click', () => window.location.href='/reports');
        
        const runAuditBtn = document.getElementById('runAuditBtn');
        if (runAuditBtn) runAuditBtn.addEventListener('click', runAuditCheck);
        
        const viewAuditDetailsBtn = document.getElementById('viewAuditDetailsBtn');
        if (viewAuditDetailsBtn) viewAuditDetailsBtn.addEventListener('click', viewAuditDetails);
        
        const downloadAuditReportBtn = document.getElementById('downloadAuditReportBtn');
        if (downloadAuditReportBtn) downloadAuditReportBtn.addEventListener('click', downloadAuditReport);
        
        const verifySignaturesBtn = document.getElementById('verifySignaturesBtn');
        if (verifySignaturesBtn) verifySignaturesBtn.addEventListener('click', verifySignatures);
        
        const signatureStatsBtn = document.getElementById('signatureStatsBtn');
        if (signatureStatsBtn) signatureStatsBtn.addEventListener('click', showSignatureStats);
    });
</script>
{% endblock %}
