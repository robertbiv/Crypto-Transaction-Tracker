{% extends "base.html" %}

{% block title %}Configuration - Crypto Tax Generator{% endblock %}

{% block extra_css %}
<style>
    .config-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        border-bottom: 2px solid var(--md-sys-color-surface-variant);
    }
    
    .config-tab {
        padding: 12px 24px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: var(--md-sys-color-on-surface-variant);
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
    }
    
    .config-tab.active {
        color: var(--md-sys-color-primary);
        border-bottom-color: var(--md-sys-color-primary);
    }
    
    .config-panel {
        display: none;
    }
    
    .config-panel.active {
        display: block;
    }
    
    .wallet-entry {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
        align-items: center;
    }
    
    .wallet-entry input {
        flex: 1;
    }
    
    .wallet-entry button {
        padding: 8px 16px;
    }
    
    .api-key-section {
        margin-bottom: 24px;
        padding: 16px;
        border: 1px solid var(--md-sys-color-surface-variant);
        border-radius: 8px;
    }
    
    .api-key-section h4 {
        margin-bottom: 12px;
    }
</style>
{% endblock %}

{% block content %}
<h1 style="margin-bottom: 24px;">Configuration</h1>

<div class="card">
    <div class="config-tabs">
        <button class="config-tab active" id="tab-general" data-tab="general">General Settings</button>
        <button class="config-tab" id="tab-wallets" data-tab="wallets">Wallets</button>
        <button class="config-tab" id="tab-apikeys" data-tab="apikeys">API Keys</button>
    </div>
    
    <!-- General Settings Panel -->
    <div id="generalPanel" class="config-panel active">
        <h3 class="card-title">Tax Configuration</h3>
        <p style="margin-bottom: 16px; color: var(--md-sys-color-on-surface-variant);">
            Configure tax calculation settings. Changes take effect after restarting calculations.
        </p>
        
        <form id="generalConfigForm">
            <h4 style="margin-top: 20px;">Accounting Method</h4>
            <div class="form-group">
                <label class="form-label" for="accounting_method">Method</label>
                <select id="accounting_method" class="form-input">
                    <option value="FIFO">FIFO (First In, First Out)</option>
                    <option value="HIFO">HIFO (Highest In, First Out)</option>
                </select>
                <div id="warning_accounting_method" class="warning-text" style="display:none; color: var(--md-sys-color-error); font-size: 12px; margin-top: 4px;">
                    ‚ö†Ô∏è HIFO is not recommended and may not align with broker 1099-DA reporting.
                </div>
            </div>

            <h4 style="margin-top: 20px;">Tax Year</h4>
            <div class="form-group">
                <label class="form-label" for="tax_year">Target Tax Year</label>
                <input type="number" id="tax_year" class="form-input" placeholder="e.g. 2025 (Leave empty for Auto-Current Year)">
                <small style="color: var(--md-sys-color-on-surface-variant);">
                    If set, the system will always run for this specific year. If empty, it will automatically use the current calendar year.
                </small>
            </div>

            <h4 style="margin-top: 20px;">Calculation Settings</h4>
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="long_term_benefit"> Apply Long Term Capital Gains Benefit
                </label>
            </div>
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="include_fees"> Include Fees in Cost Basis
                </label>
            </div>
            
            <h4 style="margin-top: 20px;">General Settings</h4>
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="run_audit"> Run audit checks
                </label>
                <div id="warning_run_audit" class="warning-text" style="display:none; color: var(--md-sys-color-error); font-size: 12px; margin-left: 24px;">
                    ‚ö†Ô∏è Disabling audit checks is not recommended.
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="create_db_backups"> Create database backups
                </label>
                <div id="warning_create_db_backups" class="warning-text" style="display:none; color: var(--md-sys-color-error); font-size: 12px; margin-left: 24px;">
                    ‚ö†Ô∏è Disabling backups puts your data at risk.
                </div>
            </div>
            
            <h4 style="margin-top: 20px;">Performance Settings</h4>
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="respect_free_tier_limits"> Respect API free tier limits
                </label>
                <div id="warning_respect_free_tier_limits" class="warning-text" style="display:none; color: var(--md-sys-color-error); font-size: 12px; margin-left: 24px;">
                    ‚ö†Ô∏è Disabling rate limits may cause API bans.
                </div>
            </div>
            <div class="form-group">
                <label class="form-label" for="api_timeout_seconds">API Timeout (seconds)</label>
                <input type="number" id="api_timeout_seconds" class="form-input" min="10" max="120">
            </div>
            
            <h4 style="margin-top: 20px;">Compliance Settings</h4>
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="strict_broker_mode"> Strict broker mode
                </label>
                <div id="warning_strict_broker_mode" class="warning-text" style="display:none; color: var(--md-sys-color-error); font-size: 12px; margin-left: 24px;">
                    ‚ö†Ô∏è Disabling strict broker mode is aggressive and may be challenged.
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="staking_taxable_on_receipt"> Staking taxable on receipt
                </label>
                <div id="warning_staking_taxable_on_receipt" class="warning-text" style="display:none; color: var(--md-sys-color-error); font-size: 12px; margin-left: 24px;">
                    ‚ö†Ô∏è Disabling taxable receipt for staking is aggressive and may be challenged.
                </div>
            </div>
            
            <h4 style="margin-top: 20px;">ü§ñ AI/ML Strategy</h4>
            <div style="background-color: var(--md-sys-color-surface-dim); padding: 12px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid var(--md-sys-color-primary);">
                <p style="margin: 0; font-size: 12px; color: var(--md-sys-color-on-surface-variant);">
                    Choose how the system should handle transactions it cannot classify using built-in rules.
                </p>
            </div>
            
            <div class="form-group" style="background: var(--md-sys-color-surface-variant); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                <div style="margin-bottom: 12px;">
                    <label style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px; cursor: pointer;">
                        <input type="radio" name="ai_strategy" value="none" style="margin-top: 4px;">
                        <div>
                            <strong>‚ùå None (Deterministic Rules Only)</strong>
                            <div style="font-size: 12px; color: var(--md-sys-color-on-surface-variant);">
                                Use only built-in classification rules. No AI/ML models. Fastest but may have unclassified transactions.
                            </div>
                        </div>
                    </label>
                </div>
                
                <div style="margin-bottom: 12px;">
                    <label style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px; cursor: pointer;">
                        <input type="radio" name="ai_strategy" value="ml_only" style="margin-top: 4px;">
                        <div>
                            <strong>‚ú® ML Fallback Only (Gemma 3n)</strong>
                            <div style="font-size: 12px; color: var(--md-sys-color-on-surface-variant);">
                                When rules cannot classify a transaction, Gemma AI suggests a classification. Good balance of accuracy and speed. Model runs locally.
                            </div>
                        </div>
                    </label>
                </div>
                
                <div>
                    <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer;">
                        <input type="radio" name="ai_strategy" value="accuracy_mode" style="margin-top: 4px;">
                        <div>
                            <strong>üéØ Accuracy Mode (Full Enhancement)</strong>
                            <div style="font-size: 12px; color: var(--md-sys-color-on-surface-variant);">
                                ML Fallback + Fraud Detection + Smart Descriptions + Pattern Learning + Natural Language Search. Best accuracy, requires more resources.
                            </div>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- ML Fallback / Accuracy Mode Options (shown when applicable) -->
            <div id="ml_options_container" style="display: none;">
                <div class="form-group">
                    <label class="form-label" for="ml_fallback_confidence_threshold">Confidence Threshold (0.0‚Äì1.0)</label>
                    <input type="number" id="ml_fallback_confidence_threshold" class="form-input" min="0" max="1" step="0.05" placeholder="0.85">
                    <small style="color: var(--md-sys-color-on-surface-variant);">
                        Minimum confidence score required to apply ML suggestions. Default: 0.85. Lower values may increase false positives.
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="ml_fallback_batch_size">Batch Size (1‚Äì100)</label>
                    <input type="number" id="ml_fallback_batch_size" class="form-input" min="1" max="100" placeholder="10">
                    <small style="color: var(--md-sys-color-on-surface-variant);">
                        <strong>üìä How it works:</strong> Transactions are processed in groups of this size before memory cleanup. Higher values = faster but use more RAM. Lower values = slower but use less RAM.
                    </small>
                    <div style="margin-top: 8px; padding: 8px; background: var(--md-sys-color-surface-dim); border-left: 3px solid var(--md-sys-color-secondary); border-radius: 4px;">
                        <div style="font-size: 12px; color: var(--md-sys-color-on-surface-variant);">
                            <strong>‚úÖ Increase to 20‚Äì50 if:</strong>
                            <div>‚Ä¢ You have 16GB+ RAM</div>
                            <div>‚Ä¢ Processing is too slow</div>
                            <div>‚Ä¢ You want to minimize pauses between batches</div>
                        </div>
                        <div style="font-size: 12px; color: var(--md-sys-color-on-surface-variant); margin-top: 8px;">
                            <strong>‚¨áÔ∏è Decrease to 1‚Äì5 if:</strong>
                            <div>‚Ä¢ You have <8GB RAM</div>
                            <div>‚Ä¢ System slows down during processing</div>
                            <div>‚Ä¢ You need to pause/resume processing frequently</div>
                        </div>
                        <div style="font-size: 12px; color: var(--md-sys-color-on-surface-variant); margin-top: 8px;">
                            <strong>üí° Default: 10</strong> Works well for most systems with 8-16GB RAM
                        </div>
                    </div>
                </div>
                
                <!-- Gemma Download Section (shown when accuracy_mode selected) -->
                <div id="configGemmaDownloadSection" style="display: none; background: #fff3cd; padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 1px solid #ffc107;">
                    <div>
                        <h4 style="margin: 0 0 8px 0; color: #856404;">üì• Gemma AI Model Setup</h4>
                        
                        <div id="configDepCheckResult" style="font-size: 12px; line-height: 1.6; color: #856404;">
                            <p>Checking dependencies...</p>
                        </div>
                        
                        <div id="configDownloadStatus" style="margin-top: 12px; padding: 12px; background: white; border-radius: 6px; display: none;">
                            <p id="configDownloadStatusText" style="margin: 0 0 8px 0;"></p>
                            <div id="configDownloadProgress" style="width: 100%; height: 6px; background: #e9ecef; border-radius: 3px; overflow: hidden; display: none;">
                                <div id="configDownloadProgressBar" style="height: 100%; background: #ffc107; width: 0%; transition: width 0.2s;"></div>
                            </div>
                        </div>
                        
                        <button type="button" id="configGemmaDownloadBtn" class="btn btn-warning" style="margin-top: 12px; display: none;">
                            üì• Download Gemma Model Now
                        </button>
                        <button type="button" id="configGemmaSkipBtn" class="btn btn-secondary" style="margin-top: 12px; display: none;">
                            ‚è≠Ô∏è Skip (Download Later)
                        </button>
                    </div>
                </div>
                
                <div id="accuracy_mode_options_container" style="display: none;">
                    <h4 style="margin-top: 16px;">Accuracy Mode Features</h4>
                    <div style="margin-bottom: 12px;">
                        <label class="form-label">
                            <input type="checkbox" id="accuracy_fraud_detection"> Context-Aware Fraud Detection
                        </label>
                        <small style="color: var(--md-sys-color-on-surface-variant); display: block; margin-left: 20px; margin-top: 4px;">
                            Detects wash sales, pump & dumps, suspicious patterns with market context
                        </small>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label class="form-label">
                            <input type="checkbox" id="accuracy_smart_descriptions"> Smart Descriptions
                        </label>
                        <small style="color: var(--md-sys-color-on-surface-variant); display: block; margin-left: 20px; margin-top: 4px;">
                            Generates creative, context-aware transaction descriptions
                        </small>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label class="form-label">
                            <input type="checkbox" id="accuracy_pattern_learning"> Pattern Learning
                        </label>
                        <small style="color: var(--md-sys-color-on-surface-variant); display: block; margin-left: 20px; margin-top: 4px;">
                            Learns your trading behavior to detect true anomalies
                        </small>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label class="form-label">
                            <input type="checkbox" id="accuracy_natural_language_search"> Natural Language Search
                        </label>
                        <small style="color: var(--md-sys-color-on-surface-variant); display: block; margin-left: 20px; margin-top: 4px;">
                            Search like "Show my largest losses in 2024" - true NLP understanding
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- Gemma System Requirements -->
            <div style="background-color: #f5f5f5; padding: 12px; border-radius: 8px; margin-bottom: 16px; border: 1px solid #e0e0e0;">
                <p style="margin: 0 0 8px 0; font-weight: 500; color: #333;">üíª Recommended System Requirements</p>
                <div style="font-size: 12px; color: #666; line-height: 1.6;">
                    <div>üìå <strong>CPU:</strong> Intel i5 / AMD Ryzen 5 or better</div>
                    <div>üìå <strong>RAM:</strong> 8GB minimum (16GB recommended)</div>
                    <div>üìå <strong>GPU:</strong> 2GB VRAM optional (NVIDIA with CUDA recommended)</div>
                    <div>üìå <strong>Storage:</strong> 5GB free for model cache</div>
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e0e0e0;">
                        <strong>üîê Privacy & Execution:</strong> All data processed locally. Gemma model runs on your machine - nothing sent to external servers.
                    </div>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">Save General Settings</button>
        </form>
    </div>
    
    <!-- Wallets Panel -->
    <div id="walletsPanel" class="config-panel">
        <h3 class="card-title">Blockchain Wallets</h3>
        <p style="margin-bottom: 16px; color: var(--md-sys-color-on-surface-variant);">
            Add your public wallet addresses for blockchain auditing. <strong>Never paste private keys!</strong>
        </p>
        
        <div id="walletsContainer">
            <p>Loading wallets...</p>
        </div>
        
        <button class="btn btn-secondary" id="btnAddWallet" style="margin-top: 16px;">
            <span class="material-icons" style="vertical-align: middle;">add</span>
            Add Wallet Address
        </button>
        <button class="btn btn-primary" id="btnSaveWallets" style="margin-top: 16px; margin-left: 12px;">
            Save All Wallets
        </button>
    </div>
    
    <!-- API Keys Panel -->
    <div id="apikeysPanel" class="config-panel">
        <h3 class="card-title">Exchange API Keys</h3>
        <p style="margin-bottom: 16px; color: var(--md-sys-color-on-surface-variant);">
            Add Read-Only API keys for exchanges. Masked values (*****) will not be updated.
        </p>
        <div class="alert alert-warning">
            <strong>‚ö†Ô∏è Security Notice:</strong> All API keys are encrypted in transit. Only add Read-Only keys with no withdrawal permissions.
        </div>
        
        <div id="apiKeysContainer">
            <p>Loading API keys...</p>
        </div>
        
        <button class="btn btn-primary" id="btnSaveApiKeys" style="margin-top: 16px;">Save API Keys</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script nonce="{{ csp_nonce }}">
    let currentTab = 'general';
    let walletsData = {};
    let apiKeysData = {};
    
    function switchTab(event, tab) {
        // Update tab buttons
        document.querySelectorAll('.config-tab').forEach(btn => {
            btn.classList.remove('active');
        });
        // Handle both click event and direct call if needed
        const target = event.currentTarget || event.target;
        target.classList.add('active');
        
        // Update panels
        document.querySelectorAll('.config-panel').forEach(panel => {
            panel.classList.remove('active');
        });
        document.getElementById(tab + 'Panel').classList.add('active');
        
        currentTab = tab;
        
        // Load data for the tab
        if (tab === 'wallets' && Object.keys(walletsData).length === 0) {
            loadWallets();
        } else if (tab === 'apikeys' && Object.keys(apiKeysData).length === 0) {
            loadApiKeys();
        }
    }
    
    function updateAIStrategyUI() {
        const strategy = document.querySelector('input[name="ai_strategy"]:checked')?.value || 'none';
        const mlContainer = document.getElementById('ml_options_container');
        const accuracyContainer = document.getElementById('accuracy_mode_options_container');
        const gemmaSection = document.getElementById('configGemmaDownloadSection');
        
        // Show/hide ML options
        if (mlContainer) {
            mlContainer.style.display = (strategy === 'ml_only' || strategy === 'accuracy_mode') ? 'block' : 'none';
        }
        
        // Show/hide Accuracy Mode options
        if (accuracyContainer) {
            accuracyContainer.style.display = strategy === 'accuracy_mode' ? 'block' : 'none';
        }
        
        // Show/hide Gemma download section for accuracy mode
        if (gemmaSection) {
            gemmaSection.style.display = strategy === 'accuracy_mode' ? 'block' : 'none';
            if (strategy === 'accuracy_mode') {
                checkConfigGemmaDependencies();
            }
        }
        
        // Enable/disable accuracy sub-features
        const accuracyControls = [
            'accuracy_fraud_detection',
            'accuracy_smart_descriptions', 
            'accuracy_pattern_learning',
            'accuracy_natural_language_search'
        ];
        
        accuracyControls.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.disabled = strategy !== 'accuracy_mode';
                if (strategy !== 'accuracy_mode') {
                    el.checked = false;
                }
            }
        });
    }
    
    async function checkConfigGemmaDependencies() {
        const resultDiv = document.getElementById('configDepCheckResult');
        
        try {
            const response = await fetch('/api/ml/check-dependencies');
            const data = await response.json();
            
            if (data.success) {
                const depsOk = data.torch_installed && data.transformers_installed;
                
                let html = '<div style="line-height: 1.8;">';
                html += `<div>${data.torch_installed ? '‚úÖ' : '‚ùå'} PyTorch: ${data.torch_installed ? 'Installed' : 'Missing'}</div>`;
                html += `<div>${data.transformers_installed ? '‚úÖ' : '‚ùå'} Transformers: ${data.transformers_installed ? 'Installed' : 'Missing'}</div>`;
                html += `<div>üì¶ Model Size: ${data.estimated_download_size_gb}GB</div>`;
                html += `<div>üíæ Free Disk: ${data.free_disk_space_gb} GB</div>`;
                html += '</div>';
                
                resultDiv.innerHTML = html;
                
                if (!depsOk) {
                    html += `<div style="margin-top: 8px; padding: 8px; background: white; border-radius: 4px; font-size: 11px;">`;
                    html += `<strong>‚ö†Ô∏è Missing dependencies</strong><br>`;
                    html += `Install with: <code>${data.install_command}</code>`;
                    html += `</div>`;
                    resultDiv.innerHTML = html;
                }
                
                const downloadBtn = document.getElementById('configGemmaDownloadBtn');
                const skipBtn = document.getElementById('configGemmaSkipBtn');
                
                if (depsOk && data.free_disk_space_gb >= 5) {
                    downloadBtn.style.display = 'block';
                    skipBtn.style.display = 'block';
                } else if (depsOk) {
                    skipBtn.style.display = 'block';
                    downloadBtn.style.display = 'none';
                } else {
                    downloadBtn.style.display = 'none';
                    skipBtn.style.display = 'none';
                }
            }
        } catch (error) {
            resultDiv.innerHTML = `<div style="color: red;">Error checking dependencies: ${error.message}</div>`;
            document.getElementById('configGemmaSkipBtn').style.display = 'block';
        }
    }
    
    async function downloadConfigGemmaModel() {
        const downloadBtn = document.getElementById('configGemmaDownloadBtn');
        const downloadStatus = document.getElementById('configDownloadStatus');
        const downloadStatusText = document.getElementById('configDownloadStatusText');
        
        downloadBtn.disabled = true;
        downloadBtn.textContent = '‚è≥ Downloading...';
        downloadStatus.style.display = 'block';
        downloadStatusText.textContent = 'Connecting to Hugging Face...';
        
        try {
            const response = await fetch('/api/ml/pre-download-model', {
                method: 'POST'
            });
            const data = await response.json();
            
            if (data.success) {
                downloadStatusText.innerHTML = '‚úÖ Model downloaded successfully! You\'re all set to use Accuracy Mode.';
                downloadBtn.textContent = '‚úÖ Download Complete';
                downloadBtn.style.backgroundColor = '#4CAF50';
            } else {
                downloadStatusText.innerHTML = `‚ö†Ô∏è ${data.message}<br><small>${data.fallback}</small>`;
                downloadBtn.textContent = 'üì• Download Gemma Model Now';
                downloadBtn.disabled = false;
            }
        } catch (error) {
            downloadStatusText.innerHTML = `‚ùå Download failed: ${error.message}`;
            downloadBtn.textContent = 'üì• Download Gemma Model Now';
            downloadBtn.disabled = false;
        }
    }
    
    function skipConfigGemmaDownload() {
        const skipBtn = document.getElementById('configGemmaSkipBtn');
        const downloadStatus = document.getElementById('configDownloadStatus');
        const downloadStatusText = document.getElementById('configDownloadStatusText');
        
        downloadStatusText.textContent = '‚è≠Ô∏è Skipped. Model will download on first use of Accuracy Mode.';
        downloadStatus.style.display = 'block';
        skipBtn.style.display = 'none';
        document.getElementById('configGemmaDownloadBtn').style.display = 'none';
    }
    
    function checkWarnings() {
        console.log('Checking warnings...');
        
        // Helper to toggle warning
        const toggle = (id, condition) => {
            const el = document.getElementById(id);
            if (el) {
                el.style.display = condition ? 'block' : 'none';
                if (condition) console.log(`Warning shown: ${id}`);
            }
        };

        // Accounting Method
        const method = document.getElementById('accounting_method');
        if (method) toggle('warning_accounting_method', method.value === 'HIFO');
            
        // Run Audit
        const runAudit = document.getElementById('run_audit');
        if (runAudit) toggle('warning_run_audit', !runAudit.checked);
            
        // Backups
        const backups = document.getElementById('create_db_backups');
        if (backups) toggle('warning_create_db_backups', !backups.checked);
            
        // Free Tier
        const freeTier = document.getElementById('respect_free_tier_limits');
        if (freeTier) toggle('warning_respect_free_tier_limits', !freeTier.checked);
            
        // Strict Broker
        const strictBroker = document.getElementById('strict_broker_mode');
        if (strictBroker) toggle('warning_strict_broker_mode', !strictBroker.checked);
            
        // Staking
        const staking = document.getElementById('staking_taxable_on_receipt');
        if (staking) toggle('warning_staking_taxable_on_receipt', !staking.checked);
    }
    
    async function loadGeneralConfig() {
        try {
            const response = await api.get('/api/config');
            const config = JSON.parse(response.data);
            
            // Populate form fields
            const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
            const setCheck = (id, val) => { const el = document.getElementById(id); if(el) el.checked = val; };

            setVal('accounting_method', config.accounting_method || 'HIFO');
            setVal('tax_year', config.tax_year || '');
            
            // New fields
            const longTerm = document.getElementById('long_term_benefit');
            if (longTerm) longTerm.checked = config.long_term_benefit !== false;
            
            const includeFees = document.getElementById('include_fees');
            if (includeFees) includeFees.checked = config.include_fees !== false;
            
            setCheck('run_audit', config.run_audit !== false);
            setCheck('create_db_backups', config.create_db_backups !== false);
            
            const perf = config.performance || {};
            setCheck('respect_free_tier_limits', perf.respect_free_tier_limits !== false);
            setVal('api_timeout_seconds', perf.api_timeout_seconds || 30);
            
            const comp = config.compliance || {};
            setCheck('strict_broker_mode', comp.strict_broker_mode !== false);
            setCheck('staking_taxable_on_receipt', comp.staking_taxable_on_receipt !== false);
            
            const ml = config.ml_fallback || {};
            const acc = config.accuracy_mode || {};
            
            // Determine AI strategy from config
            let strategy = 'none';
            if (acc.enabled === true) {
                strategy = 'accuracy_mode';
            } else if (ml.enabled === true) {
                strategy = 'ml_only';
            }
            
            // Set the AI strategy radio button
            const strategyRadio = document.querySelector(`input[name="ai_strategy"][value="${strategy}"]`);
            if (strategyRadio) strategyRadio.checked = true;
            
            // Set ML options
            setVal('ml_fallback_confidence_threshold', ml.confidence_threshold || 0.85);
            setVal('ml_fallback_batch_size', ml.batch_size || 10);
            
            // Load accuracy mode config
            setCheck('accuracy_fraud_detection', acc.fraud_detection !== false);
            setCheck('accuracy_smart_descriptions', acc.smart_descriptions !== false);
            setCheck('accuracy_pattern_learning', acc.pattern_learning !== false);
            setCheck('accuracy_natural_language_search', acc.natural_language_search !== false);
            
            // Update UI based on strategy
            updateAIStrategyUI();
            
            // Check warnings after loading
            checkWarnings();
            
            // Attach event listeners dynamically to ensure they work
            const inputs = [
                'accounting_method', 'run_audit', 'create_db_backups', 
                'respect_free_tier_limits', 'strict_broker_mode', 'staking_taxable_on_receipt',
                'ml_fallback_enabled', 'accuracy_mode_enabled'
            ];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', checkWarnings);
                    if (id === 'accuracy_mode_enabled') {
                        el.addEventListener('change', updateAccuracyModeUI);
                    }
                    // Also listen for input on select to be safe
                    if (el.tagName === 'SELECT') el.addEventListener('input', checkWarnings);
                }
            });
            
        } catch (error) {
            console.error('Load config error:', error);
            showAlert('Failed to load configuration: ' + error.message, 'error');
        }
    }
    
    document.getElementById('generalConfigForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        try {
            const taxYearVal = document.getElementById('tax_year').value;
            const strategy = document.querySelector('input[name="ai_strategy"]:checked')?.value || 'none';
            
            // Build config object
            const config = {
                accounting_method: document.getElementById('accounting_method').value,
                tax_year: taxYearVal ? parseInt(taxYearVal) : null,
                long_term_benefit: document.getElementById('long_term_benefit').checked,
                include_fees: document.getElementById('include_fees').checked,
                run_audit: document.getElementById('run_audit').checked,
                create_db_backups: document.getElementById('create_db_backups').checked,
                performance: {
                    respect_free_tier_limits: document.getElementById('respect_free_tier_limits').checked,
                    api_timeout_seconds: parseInt(document.getElementById('api_timeout_seconds').value)
                },
                compliance: {
                    strict_broker_mode: document.getElementById('strict_broker_mode').checked,
                    staking_taxable_on_receipt: document.getElementById('staking_taxable_on_receipt').checked
                },
                ml_fallback: {
                    enabled: strategy === 'ml_only' || strategy === 'accuracy_mode',
                    confidence_threshold: parseFloat(document.getElementById('ml_fallback_confidence_threshold').value) || 0.85,
                    batch_size: parseInt(document.getElementById('ml_fallback_batch_size').value) || 10
                },
                accuracy_mode: {
                    enabled: strategy === 'accuracy_mode',
                    fraud_detection: document.getElementById('accuracy_fraud_detection').checked,
                    smart_descriptions: document.getElementById('accuracy_smart_descriptions').checked,
                    pattern_learning: document.getElementById('accuracy_pattern_learning').checked,
                    natural_language_search: document.getElementById('accuracy_natural_language_search').checked
                }
            };
            
            await api.put('/api/config', config);
            
            // Show success banner
            showAlert('Configuration saved successfully!', 'success');
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
        } catch (error) {
            console.error('Save config error:', error);
            showAlert('Failed to save configuration: ' + error.message, 'error');
        }
    });
    
    async function loadWallets() {
        try {
            const response = await api.get('/api/wallets');
            walletsData = JSON.parse(response.data) || {};
            displayWallets();
        } catch (error) {
            document.getElementById('walletsContainer').innerHTML = 
                '<p style="color: var(--md-sys-color-error);">Failed to load wallets: ' + error.message + '</p>';
        }
    }
    
    function displayWallets() {
        const container = document.getElementById('walletsContainer');
        
        if (Object.keys(walletsData).length === 0 || Object.keys(walletsData).filter(k => k !== '_INSTRUCTIONS').length === 0) {
            container.innerHTML = '<p style="color: var(--md-sys-color-on-surface-variant);">No wallets configured. Click "Add Wallet Address" to add one.</p>';
            return;
        }
        
        let html = '';
        for (const [currency, walletData] of Object.entries(walletsData)) {
            if (currency === '_INSTRUCTIONS') continue;
            
            // Handle both old format (array) and new format (object with name and addresses)
            let addresses = [];
            let baseWalletName = '';
            
            if (Array.isArray(walletData)) {
                addresses = walletData;
            } else if (walletData && typeof walletData === 'object') {
                if (walletData.addresses) {
                    addresses = walletData.addresses;
                    baseWalletName = walletData.name || '';
                } else if (walletData.address) {
                    addresses = [walletData.address];
                    baseWalletName = walletData.name || '';
                }
            }
            
            addresses.forEach((address, index) => {
                const walletName = baseWalletName && addresses.length === 1 ? baseWalletName : 
                                  (baseWalletName ? `${baseWalletName} #${index + 1}` : '');
                
                html += `
                    <div class="wallet-entry" style="display: grid; grid-template-columns: 1fr 2fr 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px; align-items: start;">
                        <div>
                            <label class="form-label" style="font-size: 11px;">Blockchain</label>
                            <input type="text" class="form-input" placeholder="e.g., BTC, ETH" value="${currency}" readonly style="opacity: 0.6; background: #f5f5f5;">
                        </div>
                        <div>
                            <label class="form-label" style="font-size: 11px;">Wallet Address</label>
                            <input type="text" class="form-input" id="wallet-${currency}-${index}" placeholder="Wallet address" value="${address}" data-currency="${currency}" data-index="${index}" style="font-family: monospace; font-size: 11px;">
                        </div>
                        <div>
                            <label class="form-label" style="font-size: 11px;">Wallet Label (Optional)</label>
                            <input type="text" class="form-input wallet-name-input" id="wallet-name-${currency}-${index}" placeholder="e.g., Main Wallet" value="${walletName}" data-currency="${currency}" data-index="${index}" maxlength="50">
                        </div>
                        <button class="btn btn-secondary" onclick="testWalletAddress('${currency}', ${index})" style="margin-top: 20px;">
                            ‚úì Test
                        </button>
                        <button class="btn btn-secondary remove-wallet-btn" data-currency="${currency}" data-index="${index}" style="margin-top: 20px;">
                            <span class="material-icons" style="font-size: 16px;">delete</span>
                        </button>
                        <div id="wallet-test-result-${currency}-${index}" style="margin-top: 4px; grid-column: 1 / -1; font-size: 12px;"></div>
                    </div>
                `;
            });
        }
        
        container.innerHTML = html || '<p>No wallets configured.</p>';

        // Attach event listeners to remove buttons
        document.querySelectorAll('.remove-wallet-btn').forEach(btn => {
            btn.addEventListener('click', () => removeWallet(btn.dataset.currency, parseInt(btn.dataset.index)));
        });
    }
    
    function addWalletEntry() {
        const currency = prompt('Enter currency code (e.g., BTC, ETH, SOL):');
        if (!currency) return;
        
        const address = prompt('Enter wallet address:');
        if (!address) return;
        
        if (!walletsData[currency.toUpperCase()]) {
            walletsData[currency.toUpperCase()] = [];
        }
        
        walletsData[currency.toUpperCase()].push(address);
        displayWallets();
    }
    
    function removeWallet(currency, index) {
        if (confirm('Remove this wallet address?')) {
            walletsData[currency].splice(index, 1);
            if (walletsData[currency].length === 0) {
                delete walletsData[currency];
            }
            displayWallets();
        }
    }
    
    async function saveWallets() {
        try {
            // Collect updated values from inputs
            const addressInputs = document.querySelectorAll('#walletsContainer input[data-currency][id*="wallet-"]:not([id*="wallet-name"])');
            const updated = {};
            
            addressInputs.forEach(input => {
                const currency = input.dataset.currency;
                const index = parseInt(input.dataset.index);
                const address = input.value.trim();
                const nameInput = document.getElementById(`wallet-name-${currency}-${index}`);
                const walletName = nameInput ? nameInput.value.trim() : '';
                
                if (address) {
                    if (!updated[currency]) {
                        updated[currency] = { addresses: [], name: '' };
                    }
                    
                    // Initialize as array if not already
                    if (Array.isArray(updated[currency])) {
                        updated[currency] = { addresses: updated[currency], name: '' };
                    }
                    
                    // Ensure addresses array exists
                    if (!updated[currency].addresses) {
                        updated[currency].addresses = [];
                    }
                    
                    updated[currency].addresses[index] = address;
                    
                    // Store wallet name if provided and only one address
                    if (walletName) {
                        updated[currency].name = walletName;
                    }
                }
            });
            
            // Clean up empty indices in arrays
            for (const currency in updated) {
                if (updated[currency].addresses) {
                    updated[currency].addresses = updated[currency].addresses.filter(a => a);
                }
            }
            
            walletsData = updated;
            await api.put('/api/wallets', walletsData);
            showAlert('Wallets saved successfully', 'success');
        } catch (error) {
            showAlert('Failed to save wallets: ' + error.message, 'error');
        }
    }
    
    async function loadApiKeys() {
        try {
            const response = await api.get('/api/api-keys');
            apiKeysData = JSON.parse(response.data) || {};
            displayApiKeys();
        } catch (error) {
            document.getElementById('apiKeysContainer').innerHTML = 
                '<p style="color: var(--md-sys-color-error);">Failed to load API keys: ' + error.message + '</p>';
        }
    }
    
    function displayApiKeys() {
        const container = document.getElementById('apiKeysContainer');
        
        // All available exchanges
        const allExchanges = [
            'binance', 'binanceus', 'coinbase', 'kraken', 'gemini', 'bybit', 'kucoin', 
            'huobi', 'bitfinex', 'bitstamp', 'poloniex', 'upbit', 'bithumb'
        ];
        
        // Find which ones are configured (have values)
        const configured = allExchanges.filter(exchange => {
            const keys = apiKeysData[exchange] || {};
            return Object.values(keys).some(v => v && v !== '*****');
        });
        
        const available = allExchanges.filter(e => !configured.includes(e));
        
        let html = '';
        
        // Add dropdown for unconfigured exchanges
        if (available.length > 0) {
            html += `
                <div style="margin-bottom: 24px; padding: 16px; background: var(--md-sys-color-surface-variant); border-radius: 8px;">
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <select id="exchangeDropdown" class="form-input" style="flex: 1; max-width: 300px;">
                            <option value="">+ Add New Exchange</option>
                            ${available.map(ex => `<option value="${ex}">${ex.charAt(0).toUpperCase() + ex.slice(1)}</option>`).join('')}
                        </select>
                        <button class="btn btn-primary" onclick="addNewExchange()">Add</button>
                    </div>
                </div>
            `;
        }
        
        // Display configured exchanges
        if (configured.length > 0) {
            html += '<h4 style="margin-bottom: 16px;">Configured Exchanges</h4>';
            
            for (const exchange of configured) {
                const keys = apiKeysData[exchange] || {};
                html += `
                    <div class="api-key-section" id="exchange-${exchange}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="margin: 0;">${exchange.charAt(0).toUpperCase() + exchange.slice(1)}</h4>
                            <button class="btn btn-outline" style="padding: 6px 12px; font-size: 12px;" onclick="removeConfiguredExchange('${exchange}')">Remove</button>
                        </div>
                        <div class="form-group">
                            <label class="form-label">API Key</label>
                            <input type="text" class="form-input" id="apikey-${exchange}-key" data-exchange="${exchange}" data-field="apiKey" 
                                   value="${keys.apiKey || ''}" placeholder="Enter API key (leave blank to skip)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Secret</label>
                            <input type="password" class="form-input" id="apikey-${exchange}-secret" data-exchange="${exchange}" data-field="secret" 
                                   value="${keys.secret || ''}" placeholder="Enter secret (leave blank to skip)">
                        </div>
                        <button class="btn btn-secondary" style="margin-bottom: 16px;" onclick="testApiKey('${exchange}')">
                            Test Connection
                        </button>
                        <div id="test-result-${exchange}" style="margin-top: 8px;"></div>
                    </div>
                `;
            }
        } else {
            html += '<p style="color: var(--md-sys-color-on-surface-variant);">No API keys configured yet. Add one from the dropdown above.</p>';
        }
        
        container.innerHTML = html;
    }
    
    function addNewExchange() {
        const dropdown = document.getElementById('exchangeDropdown');
        const exchange = dropdown.value;
        if (!exchange) return;
        
        // Add to apiKeysData
        if (!apiKeysData[exchange]) {
            apiKeysData[exchange] = { apiKey: '', secret: '' };
        }
        
        // Refresh display
        displayApiKeys();
    }
    
    function removeConfiguredExchange(exchange) {
        delete apiKeysData[exchange];
        displayApiKeys();
    }
    
    async function saveApiKeys() {
        try {
            // Collect values from inputs
            const inputs = document.querySelectorAll('#apiKeysContainer input[data-exchange]');
            const updated = {};
            
            inputs.forEach(input => {
                const exchange = input.dataset.exchange;
                const field = input.dataset.field;
                const value = input.value.trim();
                
                if (!updated[exchange]) {
                    updated[exchange] = {};
                }
                
                // Only update non-masked values
                if (value && !value.includes('*')) {
                    updated[exchange][field] = value;
                }
            });
            
            await api.put('/api/api-keys', updated);
            showAlert('API keys saved successfully. Masked values were not updated.', 'success');
            await loadApiKeys(); // Reload to show masked values
        } catch (error) {
            showAlert('Failed to save API keys: ' + error.message, 'error');
        }
    }
    
    async function testApiKey(exchange) {
        const resultDiv = document.getElementById('test-result-' + exchange);
        const apiKeyInput = document.getElementById('apikey-' + exchange + '-key');
        const secretInput = document.getElementById('apikey-' + exchange + '-secret');
        
        const apiKey = apiKeyInput.value.trim();
        const secret = secretInput.value.trim();
        
        if (!apiKey || !secret || apiKey.includes('*')) {
            resultDiv.innerHTML = '<p style="color: var(--md-sys-color-error); font-size: 14px;">Please enter both API key and secret (unmasked values)</p>';
            return;
        }
        
        resultDiv.innerHTML = '<p style="color: var(--md-sys-color-on-surface-variant); font-size: 14px;">Testing...</p>';
        
        try {
            const response = await fetch('/api/api-keys/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.getElementById('csrf_token').value
                },
                body: JSON.stringify({
                    exchange: exchange,
                    apiKey: apiKey,
                    secret: secret
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                resultDiv.innerHTML = `<p style="color: var(--md-sys-color-tertiary); font-size: 14px;">${result.message}</p>`;
            } else if (result.error) {
                resultDiv.innerHTML = `<p style="color: var(--md-sys-color-error); font-size: 14px;">‚úó ${result.error}</p>`;
            } else {
                resultDiv.innerHTML = `<p style="color: var(--md-sys-color-error); font-size: 14px;">‚úó Test failed: Unknown error</p>`;
            }
        } catch (error) {
            resultDiv.innerHTML = `<p style="color: var(--md-sys-color-error); font-size: 14px;">‚úó Test failed: ${error.message}</p>`;
        }
    }
    
    async function testWalletAddress(currency, index) {
        const resultDiv = document.getElementById('wallet-test-result-' + currency + '-' + index);
        const addressInput = document.getElementById('wallet-' + currency + '-' + index);
        const address = addressInput.value.trim();
        
        if (!address) {
            resultDiv.innerHTML = '<p style="color: var(--md-sys-color-error); font-size: 14px;">Please enter a wallet address</p>';
            return;
        }
        
        resultDiv.innerHTML = '<p style="color: var(--md-sys-color-on-surface-variant); font-size: 14px;">Validating format...</p>';
        
        try {
            const response = await fetch('/api/wallets/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.getElementById('csrf_token').value
                },
                body: JSON.stringify({
                    blockchain: currency,
                    address: address
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                resultDiv.innerHTML = `<p style="color: var(--md-sys-color-tertiary); font-size: 14px;">${result.message}</p>`;
            } else if (result.error) {
                resultDiv.innerHTML = `<p style="color: var(--md-sys-color-error); font-size: 14px;">‚úó ${result.error}</p>`;
            } else {
                resultDiv.innerHTML = `<p style="color: var(--md-sys-color-error); font-size: 14px;">‚úó Validation failed: Unknown error</p>`;
            }
        } catch (error) {
            resultDiv.innerHTML = `<p style="color: var(--md-sys-color-error); font-size: 14px;">‚úó Validation failed: ${error.message}</p>`;
        }
    }
    
    // Load general config on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadGeneralConfig();
        
        // Attach event listeners
        document.querySelectorAll('.config-tab').forEach(btn => {
            btn.addEventListener('click', (e) => switchTab(e, btn.dataset.tab));
        });
        
        // Listen to AI strategy changes - handle Gemma deletion when disabling
        document.querySelectorAll('input[name="ai_strategy"]').forEach(radio => {
            radio.addEventListener('change', async (e) => {
                const newStrategy = e.target.value;
                const oldStrategy = document.querySelector('input[name="ai_strategy"]').getAttribute('data-previous-strategy') || 'none';
                
                // If switching FROM accuracy_mode TO something else, offer to delete Gemma
                if (oldStrategy === 'accuracy_mode' && newStrategy !== 'accuracy_mode') {
                    showGemmaDeleteConfirmation();
                }
                
                // Update the previous strategy for next time
                document.querySelectorAll('input[name="ai_strategy"]').forEach(r => {
                    if (r.checked) {
                        r.setAttribute('data-previous-strategy', newStrategy);
                    }
                });
                
                updateAIStrategyUI();
            });
        });
        
        // Listen to Gemma download buttons
        const downloadBtn = document.getElementById('configGemmaDownloadBtn');
        const skipBtn = document.getElementById('configGemmaSkipBtn');
        
        if (downloadBtn) downloadBtn.addEventListener('click', downloadConfigGemmaModel);
        if (skipBtn) skipBtn.addEventListener('click', skipConfigGemmaDownload);
        
        document.getElementById('btnAddWallet').addEventListener('click', () => {
            document.querySelectorAll('.wallet-entry:last-child')[0]?.scrollIntoView({ behavior: 'smooth' });
        });
        
        document.getElementById('btnSaveWallets').addEventListener('click', saveWallets);
        document.getElementById('btnSaveApiKeys').addEventListener('click', saveApiKeys);
    });
    
    async function showGemmaDeleteConfirmation() {
        const confirmed = confirm(
            'You are disabling Accuracy Mode.\n\n' +
            'Would you like to delete the downloaded Gemma AI model to free up 5-10GB of disk space?\n\n' +
            'You can re-download it later if needed.'
        );
        if (confirmed) {
            await deleteGemmaModel();
        }
    }
    
    async function deleteGemmaModel() {
        try {
            const response = await fetch('/api/ml/delete-gemma-model', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.getElementById('csrf_token')?.value || ''
                }
            });
            const data = await response.json();
            if (data.success) {
                showAlert(`‚úÖ Gemma model deleted successfully! Freed up ${data.freed_space_gb}GB of disk space.`, 'success');
            } else {
                showAlert(`‚ö†Ô∏è Could not delete model: ${data.message}`, 'warning');
            }
        } catch (error) {
            showAlert(`‚ùå Error deleting Gemma model: ${error.message}`, 'error');
        }
    }
</script>
{% endblock %}
