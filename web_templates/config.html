{% extends "base.html" %}

{% block title %}Configuration - Crypto Tax Generator{% endblock %}

{% block extra_css %}
<style>
    .config-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        border-bottom: 2px solid var(--md-sys-color-surface-variant);
    }
    
    .config-tab {
        padding: 12px 24px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: var(--md-sys-color-on-surface-variant);
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
    }
    
    .config-tab.active {
        color: var(--md-sys-color-primary);
        border-bottom-color: var(--md-sys-color-primary);
    }
    
    .config-panel {
        display: none;
    }
    
    .config-panel.active {
        display: block;
    }
    
    .wallet-entry {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
        align-items: center;
    }
    
    .wallet-entry input {
        flex: 1;
    }
    
    .wallet-entry button {
        padding: 8px 16px;
    }
    
    .api-key-section {
        margin-bottom: 24px;
        padding: 16px;
        border: 1px solid var(--md-sys-color-surface-variant);
        border-radius: 8px;
    }
    
    .api-key-section h4 {
        margin-bottom: 12px;
    }
</style>
{% endblock %}

{% block content %}
<h1 style="margin-bottom: 24px;">Configuration</h1>

<div class="card">
    <div class="config-tabs">
        <button class="config-tab active" id="tab-general" data-tab="general">General Settings</button>
        <button class="config-tab" id="tab-wallets" data-tab="wallets">Wallets</button>
        <button class="config-tab" id="tab-apikeys" data-tab="apikeys">API Keys</button>
    </div>
    
    <!-- General Settings Panel -->
    <div id="generalPanel" class="config-panel active">
        <h3 class="card-title">Tax Configuration</h3>
        <p style="margin-bottom: 16px; color: var(--md-sys-color-on-surface-variant);">
            Configure tax calculation settings. Changes take effect after restarting calculations.
        </p>
        
        <form id="generalConfigForm">
            <h4 style="margin-top: 20px;">Accounting Method</h4>
            <div class="form-group">
                <label class="form-label" for="accounting_method">Method</label>
                <select id="accounting_method" class="form-input">
                    <option value="FIFO">FIFO (First In, First Out)</option>
                    <option value="HIFO">HIFO (Highest In, First Out)</option>
                </select>
                <div id="warning_accounting_method" class="warning-text" style="display:none; color: var(--md-sys-color-error); font-size: 12px; margin-top: 4px;">
                    ⚠️ HIFO is not recommended and may not align with broker 1099-DA reporting.
                </div>
            </div>

            <h4 style="margin-top: 20px;">Tax Year</h4>
            <div class="form-group">
                <label class="form-label" for="tax_year">Target Tax Year</label>
                <input type="number" id="tax_year" class="form-input" placeholder="e.g. 2025 (Leave empty for Auto-Current Year)">
                <small style="color: var(--md-sys-color-on-surface-variant);">
                    If set, the system will always run for this specific year. If empty, it will automatically use the current calendar year.
                </small>
            </div>

            <h4 style="margin-top: 20px;">Calculation Settings</h4>
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="long_term_benefit"> Apply Long Term Capital Gains Benefit
                </label>
            </div>
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="include_fees"> Include Fees in Cost Basis
                </label>
            </div>
            
            <h4 style="margin-top: 20px;">General Settings</h4>
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="run_audit"> Run audit checks
                </label>
                <div id="warning_run_audit" class="warning-text" style="display:none; color: var(--md-sys-color-error); font-size: 12px; margin-left: 24px;">
                    ⚠️ Disabling audit checks is not recommended.
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="create_db_backups"> Create database backups
                </label>
                <div id="warning_create_db_backups" class="warning-text" style="display:none; color: var(--md-sys-color-error); font-size: 12px; margin-left: 24px;">
                    ⚠️ Disabling backups puts your data at risk.
                </div>
            </div>
            
            <h4 style="margin-top: 20px;">Performance Settings</h4>
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="respect_free_tier_limits"> Respect API free tier limits
                </label>
                <div id="warning_respect_free_tier_limits" class="warning-text" style="display:none; color: var(--md-sys-color-error); font-size: 12px; margin-left: 24px;">
                    ⚠️ Disabling rate limits may cause API bans.
                </div>
            </div>
            <div class="form-group">
                <label class="form-label" for="api_timeout_seconds">API Timeout (seconds)</label>
                <input type="number" id="api_timeout_seconds" class="form-input" min="10" max="120">
            </div>
            
            <h4 style="margin-top: 20px;">Compliance Settings</h4>
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="strict_broker_mode"> Strict broker mode
                </label>
                <div id="warning_strict_broker_mode" class="warning-text" style="display:none; color: var(--md-sys-color-error); font-size: 12px; margin-left: 24px;">
                    ⚠️ Disabling strict broker mode is aggressive and may be challenged.
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="staking_taxable_on_receipt"> Staking taxable on receipt
                </label>
                <div id="warning_staking_taxable_on_receipt" class="warning-text" style="display:none; color: var(--md-sys-color-error); font-size: 12px; margin-left: 24px;">
                    ⚠️ Disabling taxable receipt for staking is aggressive and may be challenged.
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">Save General Settings</button>
        </form>
    </div>
    
    <!-- Wallets Panel -->
    <div id="walletsPanel" class="config-panel">
        <h3 class="card-title">Blockchain Wallets</h3>
        <p style="margin-bottom: 16px; color: var(--md-sys-color-on-surface-variant);">
            Add your public wallet addresses for blockchain auditing. <strong>Never paste private keys!</strong>
        </p>
        
        <div id="walletsContainer">
            <p>Loading wallets...</p>
        </div>
        
        <button class="btn btn-secondary" id="btnAddWallet" style="margin-top: 16px;">
            <span class="material-icons" style="vertical-align: middle;">add</span>
            Add Wallet Address
        </button>
        <button class="btn btn-primary" id="btnSaveWallets" style="margin-top: 16px; margin-left: 12px;">
            Save All Wallets
        </button>
    </div>
    
    <!-- API Keys Panel -->
    <div id="apikeysPanel" class="config-panel">
        <h3 class="card-title">Exchange API Keys</h3>
        <p style="margin-bottom: 16px; color: var(--md-sys-color-on-surface-variant);">
            Add Read-Only API keys for exchanges. Masked values (*****) will not be updated.
        </p>
        <div class="alert alert-warning">
            <strong>⚠️ Security Notice:</strong> All API keys are encrypted in transit. Only add Read-Only keys with no withdrawal permissions.
        </div>
        
        <div id="apiKeysContainer">
            <p>Loading API keys...</p>
        </div>
        
        <button class="btn btn-primary" id="btnSaveApiKeys" style="margin-top: 16px;">Save API Keys</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script nonce="{{ csp_nonce }}">
    let currentTab = 'general';
    let walletsData = {};
    let apiKeysData = {};
    
    function switchTab(event, tab) {
        // Update tab buttons
        document.querySelectorAll('.config-tab').forEach(btn => {
            btn.classList.remove('active');
        });
        // Handle both click event and direct call if needed
        const target = event.currentTarget || event.target;
        target.classList.add('active');
        
        // Update panels
        document.querySelectorAll('.config-panel').forEach(panel => {
            panel.classList.remove('active');
        });
        document.getElementById(tab + 'Panel').classList.add('active');
        
        currentTab = tab;
        
        // Load data for the tab
        if (tab === 'wallets' && Object.keys(walletsData).length === 0) {
            loadWallets();
        } else if (tab === 'apikeys' && Object.keys(apiKeysData).length === 0) {
            loadApiKeys();
        }
    }
    
    function checkWarnings() {
        console.log('Checking warnings...');
        
        // Helper to toggle warning
        const toggle = (id, condition) => {
            const el = document.getElementById(id);
            if (el) {
                el.style.display = condition ? 'block' : 'none';
                if (condition) console.log(`Warning shown: ${id}`);
            }
        };

        // Accounting Method
        const method = document.getElementById('accounting_method');
        if (method) toggle('warning_accounting_method', method.value === 'HIFO');
            
        // Run Audit
        const runAudit = document.getElementById('run_audit');
        if (runAudit) toggle('warning_run_audit', !runAudit.checked);
            
        // Backups
        const backups = document.getElementById('create_db_backups');
        if (backups) toggle('warning_create_db_backups', !backups.checked);
            
        // Free Tier
        const freeTier = document.getElementById('respect_free_tier_limits');
        if (freeTier) toggle('warning_respect_free_tier_limits', !freeTier.checked);
            
        // Strict Broker
        const strictBroker = document.getElementById('strict_broker_mode');
        if (strictBroker) toggle('warning_strict_broker_mode', !strictBroker.checked);
            
        // Staking
        const staking = document.getElementById('staking_taxable_on_receipt');
        if (staking) toggle('warning_staking_taxable_on_receipt', !staking.checked);
    }
    
    async function loadGeneralConfig() {
        try {
            const response = await api.get('/api/config');
            const config = JSON.parse(response.data);
            
            // Populate form fields
            const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
            const setCheck = (id, val) => { const el = document.getElementById(id); if(el) el.checked = val; };

            setVal('accounting_method', config.accounting_method || 'HIFO');
            setVal('tax_year', config.tax_year || '');
            
            // New fields
            const longTerm = document.getElementById('long_term_benefit');
            if (longTerm) longTerm.checked = config.long_term_benefit !== false;
            
            const includeFees = document.getElementById('include_fees');
            if (includeFees) includeFees.checked = config.include_fees !== false;
            
            setCheck('run_audit', config.run_audit !== false);
            setCheck('create_db_backups', config.create_db_backups !== false);
            
            const perf = config.performance || {};
            setCheck('respect_free_tier_limits', perf.respect_free_tier_limits !== false);
            setVal('api_timeout_seconds', perf.api_timeout_seconds || 30);
            
            const comp = config.compliance || {};
            setCheck('strict_broker_mode', comp.strict_broker_mode !== false);
            setCheck('staking_taxable_on_receipt', comp.staking_taxable_on_receipt !== false);
            
            // Check warnings after loading
            checkWarnings();
            
            // Attach event listeners dynamically to ensure they work
            const inputs = [
                'accounting_method', 'run_audit', 'create_db_backups', 
                'respect_free_tier_limits', 'strict_broker_mode', 'staking_taxable_on_receipt'
            ];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', checkWarnings);
                    // Also listen for input on select to be safe
                    if (el.tagName === 'SELECT') el.addEventListener('input', checkWarnings);
                }
            });
            
        } catch (error) {
            console.error('Load config error:', error);
            showAlert('Failed to load configuration: ' + error.message, 'error');
        }
    }
    
    document.getElementById('generalConfigForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        try {
            const taxYearVal = document.getElementById('tax_year').value;
            
            // Build config object
            const config = {
                accounting_method: document.getElementById('accounting_method').value,
                tax_year: taxYearVal ? parseInt(taxYearVal) : null,
                long_term_benefit: document.getElementById('long_term_benefit').checked,
                include_fees: document.getElementById('include_fees').checked,
                run_audit: document.getElementById('run_audit').checked,
                create_db_backups: document.getElementById('create_db_backups').checked,
                performance: {
                    respect_free_tier_limits: document.getElementById('respect_free_tier_limits').checked,
                    api_timeout_seconds: parseInt(document.getElementById('api_timeout_seconds').value)
                },
                compliance: {
                    strict_broker_mode: document.getElementById('strict_broker_mode').checked,
                    staking_taxable_on_receipt: document.getElementById('staking_taxable_on_receipt').checked
                }
            };
            
            await api.put('/api/config', config);
            
            // Show success banner
            showAlert('Configuration saved successfully!', 'success');
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
        } catch (error) {
            console.error('Save config error:', error);
            showAlert('Failed to save configuration: ' + error.message, 'error');
        }
    });
    
    async function loadWallets() {
        try {
            const response = await api.get('/api/wallets');
            walletsData = JSON.parse(response.data) || {};
            displayWallets();
        } catch (error) {
            document.getElementById('walletsContainer').innerHTML = 
                '<p style="color: var(--md-sys-color-error);">Failed to load wallets: ' + error.message + '</p>';
        }
    }
    
    function displayWallets() {
        const container = document.getElementById('walletsContainer');
        
        if (Object.keys(walletsData).length === 0) {
            container.innerHTML = '<p style="color: var(--md-sys-color-on-surface-variant);">No wallets configured. Click "Add Wallet Address" to add one.</p>';
            return;
        }
        
        let html = '';
        for (const [currency, addresses] of Object.entries(walletsData)) {
            if (Array.isArray(addresses)) {
                addresses.forEach((address, index) => {
                    html += `
                        <div class="wallet-entry">
                            <input type="text" class="form-input" placeholder="Currency (e.g., BTC, ETH)" value="${currency}" readonly>
                            <input type="text" class="form-input" id="wallet-${currency}-${index}" placeholder="Wallet address" value="${address}" data-currency="${currency}" data-index="${index}">
                            <button class="btn btn-secondary" onclick="testWalletAddress('${currency}', ${index})" style="margin-right: 8px;">
                                Test
                            </button>
                            <button class="btn btn-secondary remove-wallet-btn" data-currency="${currency}" data-index="${index}">
                                <span class="material-icons" style="font-size: 16px;">delete</span>
                            </button>
                            <div id="wallet-test-result-${currency}-${index}" style="margin-top: 4px; grid-column: 2 / -1;"></div>
                        </div>
                    `;
                });
            }
        }
        
        container.innerHTML = html || '<p>No wallets configured.</p>';

        // Attach event listeners to remove buttons
        document.querySelectorAll('.remove-wallet-btn').forEach(btn => {
            btn.addEventListener('click', () => removeWallet(btn.dataset.currency, parseInt(btn.dataset.index)));
        });
    }
    
    function addWalletEntry() {
        const currency = prompt('Enter currency code (e.g., BTC, ETH, SOL):');
        if (!currency) return;
        
        const address = prompt('Enter wallet address:');
        if (!address) return;
        
        if (!walletsData[currency.toUpperCase()]) {
            walletsData[currency.toUpperCase()] = [];
        }
        
        walletsData[currency.toUpperCase()].push(address);
        displayWallets();
    }
    
    function removeWallet(currency, index) {
        if (confirm('Remove this wallet address?')) {
            walletsData[currency].splice(index, 1);
            if (walletsData[currency].length === 0) {
                delete walletsData[currency];
            }
            displayWallets();
        }
    }
    
    async function saveWallets() {
        try {
            // Collect updated values from inputs
            const inputs = document.querySelectorAll('#walletsContainer input[data-currency]');
            const updated = {};
            
            inputs.forEach(input => {
                const currency = input.dataset.currency;
                const index = parseInt(input.dataset.index);
                const value = input.value.trim();
                
                if (value) {
                    if (!updated[currency]) {
                        updated[currency] = [];
                    }
                    updated[currency][index] = value;
                }
            });
            
            walletsData = updated;
            await api.put('/api/wallets', walletsData);
            showAlert('Wallets saved successfully', 'success');
        } catch (error) {
            showAlert('Failed to save wallets: ' + error.message, 'error');
        }
    }
    
    async function loadApiKeys() {
        try {
            const response = await api.get('/api/api-keys');
            apiKeysData = JSON.parse(response.data) || {};
            displayApiKeys();
        } catch (error) {
            document.getElementById('apiKeysContainer').innerHTML = 
                '<p style="color: var(--md-sys-color-error);">Failed to load API keys: ' + error.message + '</p>';
        }
    }
    
    function displayApiKeys() {
        const container = document.getElementById('apiKeysContainer');
        
        // All available exchanges
        const allExchanges = [
            'binance', 'binanceus', 'coinbase', 'kraken', 'gemini', 'bybit', 'kucoin', 
            'huobi', 'bitfinex', 'bitstamp', 'poloniex', 'upbit', 'bithumb'
        ];
        
        // Find which ones are configured (have values)
        const configured = allExchanges.filter(exchange => {
            const keys = apiKeysData[exchange] || {};
            return Object.values(keys).some(v => v && v !== '*****');
        });
        
        const available = allExchanges.filter(e => !configured.includes(e));
        
        let html = '';
        
        // Add dropdown for unconfigured exchanges
        if (available.length > 0) {
            html += `
                <div style="margin-bottom: 24px; padding: 16px; background: var(--md-sys-color-surface-variant); border-radius: 8px;">
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <select id="exchangeDropdown" class="form-input" style="flex: 1; max-width: 300px;">
                            <option value="">+ Add New Exchange</option>
                            ${available.map(ex => `<option value="${ex}">${ex.charAt(0).toUpperCase() + ex.slice(1)}</option>`).join('')}
                        </select>
                        <button class="btn btn-primary" onclick="addNewExchange()">Add</button>
                    </div>
                </div>
            `;
        }
        
        // Display configured exchanges
        if (configured.length > 0) {
            html += '<h4 style="margin-bottom: 16px;">Configured Exchanges</h4>';
            
            for (const exchange of configured) {
                const keys = apiKeysData[exchange] || {};
                html += `
                    <div class="api-key-section" id="exchange-${exchange}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="margin: 0;">${exchange.charAt(0).toUpperCase() + exchange.slice(1)}</h4>
                            <button class="btn btn-outline" style="padding: 6px 12px; font-size: 12px;" onclick="removeConfiguredExchange('${exchange}')">Remove</button>
                        </div>
                        <div class="form-group">
                            <label class="form-label">API Key</label>
                            <input type="text" class="form-input" id="apikey-${exchange}-key" data-exchange="${exchange}" data-field="apiKey" 
                                   value="${keys.apiKey || ''}" placeholder="Enter API key (leave blank to skip)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Secret</label>
                            <input type="password" class="form-input" id="apikey-${exchange}-secret" data-exchange="${exchange}" data-field="secret" 
                                   value="${keys.secret || ''}" placeholder="Enter secret (leave blank to skip)">
                        </div>
                        <button class="btn btn-secondary" style="margin-bottom: 16px;" onclick="testApiKey('${exchange}')">
                            Test Connection
                        </button>
                        <div id="test-result-${exchange}" style="margin-top: 8px;"></div>
                    </div>
                `;
            }
        } else {
            html += '<p style="color: var(--md-sys-color-on-surface-variant);">No API keys configured yet. Add one from the dropdown above.</p>';
        }
        
        container.innerHTML = html;
    }
    
    function addNewExchange() {
        const dropdown = document.getElementById('exchangeDropdown');
        const exchange = dropdown.value;
        if (!exchange) return;
        
        // Add to apiKeysData
        if (!apiKeysData[exchange]) {
            apiKeysData[exchange] = { apiKey: '', secret: '' };
        }
        
        // Refresh display
        displayApiKeys();
    }
    
    function removeConfiguredExchange(exchange) {
        delete apiKeysData[exchange];
        displayApiKeys();
    }
    
    async function saveApiKeys() {
        try {
            // Collect values from inputs
            const inputs = document.querySelectorAll('#apiKeysContainer input[data-exchange]');
            const updated = {};
            
            inputs.forEach(input => {
                const exchange = input.dataset.exchange;
                const field = input.dataset.field;
                const value = input.value.trim();
                
                if (!updated[exchange]) {
                    updated[exchange] = {};
                }
                
                // Only update non-masked values
                if (value && !value.includes('*')) {
                    updated[exchange][field] = value;
                }
            });
            
            await api.put('/api/api-keys', updated);
            showAlert('API keys saved successfully. Masked values were not updated.', 'success');
            await loadApiKeys(); // Reload to show masked values
        } catch (error) {
            showAlert('Failed to save API keys: ' + error.message, 'error');
        }
    }
    
    async function testApiKey(exchange) {
        const resultDiv = document.getElementById('test-result-' + exchange);
        const apiKeyInput = document.getElementById('apikey-' + exchange + '-key');
        const secretInput = document.getElementById('apikey-' + exchange + '-secret');
        
        const apiKey = apiKeyInput.value.trim();
        const secret = secretInput.value.trim();
        
        if (!apiKey || !secret || apiKey.includes('*')) {
            resultDiv.innerHTML = '<p style="color: var(--md-sys-color-error); font-size: 14px;">Please enter both API key and secret (unmasked values)</p>';
            return;
        }
        
        resultDiv.innerHTML = '<p style="color: var(--md-sys-color-on-surface-variant); font-size: 14px;">Testing...</p>';
        
        try {
            const response = await fetch('/api/api-keys/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.getElementById('csrf_token').value
                },
                body: JSON.stringify({
                    exchange: exchange,
                    apiKey: apiKey,
                    secret: secret
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                resultDiv.innerHTML = `<p style="color: var(--md-sys-color-tertiary); font-size: 14px;">${result.message}</p>`;
            } else if (result.error) {
                resultDiv.innerHTML = `<p style="color: var(--md-sys-color-error); font-size: 14px;">✗ ${result.error}</p>`;
            } else {
                resultDiv.innerHTML = `<p style="color: var(--md-sys-color-error); font-size: 14px;">✗ Test failed: Unknown error</p>`;
            }
        } catch (error) {
            resultDiv.innerHTML = `<p style="color: var(--md-sys-color-error); font-size: 14px;">✗ Test failed: ${error.message}</p>`;
        }
    }
    
    async function testWalletAddress(currency, index) {
        const resultDiv = document.getElementById('wallet-test-result-' + currency + '-' + index);
        const addressInput = document.getElementById('wallet-' + currency + '-' + index);
        const address = addressInput.value.trim();
        
        if (!address) {
            resultDiv.innerHTML = '<p style="color: var(--md-sys-color-error); font-size: 14px;">Please enter a wallet address</p>';
            return;
        }
        
        resultDiv.innerHTML = '<p style="color: var(--md-sys-color-on-surface-variant); font-size: 14px;">Validating format...</p>';
        
        try {
            const response = await fetch('/api/wallets/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.getElementById('csrf_token').value
                },
                body: JSON.stringify({
                    blockchain: currency,
                    address: address
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                resultDiv.innerHTML = `<p style="color: var(--md-sys-color-tertiary); font-size: 14px;">${result.message}</p>`;
            } else if (result.error) {
                resultDiv.innerHTML = `<p style="color: var(--md-sys-color-error); font-size: 14px;">✗ ${result.error}</p>`;
            } else {
                resultDiv.innerHTML = `<p style="color: var(--md-sys-color-error); font-size: 14px;">✗ Validation failed: Unknown error</p>`;
            }
        } catch (error) {
            resultDiv.innerHTML = `<p style="color: var(--md-sys-color-error); font-size: 14px;">✗ Validation failed: ${error.message}</p>`;
        }
    }
    
    // Load general config on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadGeneralConfig();
        
        // Attach event listeners
        document.querySelectorAll('.config-tab').forEach(btn => {
            btn.addEventListener('click', (e) => switchTab(e, btn.dataset.tab));
        });
        
        const btnAddWallet = document.getElementById('btnAddWallet');
        if (btnAddWallet) btnAddWallet.addEventListener('click', addWalletEntry);
        
        const btnSaveWallets = document.getElementById('btnSaveWallets');
        if (btnSaveWallets) btnSaveWallets.addEventListener('click', saveWallets);
        
        const btnSaveApiKeys = document.getElementById('btnSaveApiKeys');
        if (btnSaveApiKeys) btnSaveApiKeys.addEventListener('click', saveApiKeys);
    });
</script>
{% endblock %}
