<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automatic Response Management</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        .header {
            background: linear-gradient(135deg, #ef5350 0%, #f44336 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { opacity: 0.9; }
        
        .status-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .status-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 4px solid #667eea;
        }
        .status-card.critical { border-left-color: #ef5350; }
        .status-card.high { border-left-color: #ff9800; }
        .status-card.medium { border-left-color: #ffc107; }
        .status-card.low { border-left-color: #4caf50; }
        
        .status-card h3 {
            color: #666;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        .status-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        
        .alert-critical {
            background: #ffebee;
            border: 2px solid #ef5350;
            color: #c62828;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .alert-critical h2 {
            margin-bottom: 10px;
            font-size: 20px;
        }
        
        .lock-status {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 2px solid #667eea;
        }
        .lock-status h2 { margin-bottom: 15px; color: #333; }
        
        .lock-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .lock-item {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            border-left: 3px solid #667eea;
        }
        .lock-item label {
            display: block;
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        .lock-item .value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .countdown {
            font-size: 24px;
            font-weight: bold;
            color: #ef5350;
        }
        
        .lock-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover { background: #5568d3; }
        .btn-danger {
            background: #ef5350;
            color: white;
        }
        .btn-danger:hover { background: #e53935; }
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        .btn-secondary:hover { background: #e0e0e0; }
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .incidents-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 22px;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            display: inline-block;
        }
        
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 20px;
            font-size: 13px;
            transition: all 0.3s;
        }
        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .filter-btn:hover {
            border-color: #667eea;
        }
        
        .incidents-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .incidents-table th {
            background: #f9f9f9;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #666;
            border-bottom: 2px solid #eee;
            font-size: 13px;
            text-transform: uppercase;
        }
        
        .incidents-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .incidents-table tr:hover {
            background: #fafafa;
        }
        
        .severity-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .severity-critical {
            background: #ffcdd2;
            color: #c62828;
        }
        .severity-high {
            background: #ffe0b2;
            color: #e65100;
        }
        .severity-medium {
            background: #fff9c4;
            color: #f57f17;
        }
        .severity-low {
            background: #c8e6c9;
            color: #2e7d32;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-active {
            background: #ffcdd2;
            color: #c62828;
        }
        .status-resolved {
            background: #c8e6c9;
            color: #2e7d32;
        }
        .status-escalated {
            background: #ffe0b2;
            color: #e65100;
        }
        
        .incident-details {
            display: none;
            background: #f9f9f9;
            padding: 20px;
            border-top: 1px solid #eee;
            animation: slideDown 0.3s ease;
        }
        .incident-details.show { display: block; }
        
        @keyframes slideDown {
            from { opacity: 0; max-height: 0; }
            to { opacity: 1; max-height: 500px; }
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .detail-item {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border-left: 3px solid #667eea;
        }
        .detail-item label {
            display: block;
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        .detail-item .value {
            word-break: break-all;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
        }
        
        .incident-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .forensic-section {
            margin-top: 20px;
            background: white;
            padding: 15px;
            border-radius: 4px;
        }
        .forensic-section h4 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .snapshot-list {
            list-style: none;
            display: grid;
            gap: 10px;
        }
        
        .snapshot-item {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 4px;
            border-left: 3px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .snapshot-time {
            font-size: 13px;
            color: #666;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .empty-state h3 { margin-bottom: 10px; }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .tab {
            padding: 15px 20px;
            cursor: pointer;
            font-weight: 600;
            color: #999;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        .tab:hover { color: #666; }
        
        .tab-content {
            display: none;
        }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî¥ Automatic Response Management</h1>
            <p>Monitor, manage, and respond to security incidents in real-time</p>
        </div>
        
        <!-- Status Overview -->
        <div class="status-panel">
            <div class="status-card critical" id="card-critical">
                <h3>üî¥ Critical</h3>
                <div class="value">0</div>
            </div>
            <div class="status-card high" id="card-high">
                <h3>üü† High</h3>
                <div class="value">0</div>
            </div>
            <div class="status-card medium" id="card-medium">
                <h3>üü° Medium</h3>
                <div class="value">0</div>
            </div>
            <div class="status-card low" id="card-low">
                <h3>üü¢ Low</h3>
                <div class="value">0</div>
            </div>
        </div>
        
        <!-- Critical Alert if Locked -->
        <div id="lock-alert" class="alert-critical" style="display: none;">
            <h2>‚ö†Ô∏è DATABASE LOCKED - OPERATIONS SUSPENDED</h2>
            <p id="lock-alert-text">The database has been locked due to a security incident. Review the incident details below and take appropriate action.</p>
        </div>
        
        <!-- Lock Status -->
        <div class="lock-status" id="lock-status" style="display: none;">
            <h2>üîí Current Lock Status</h2>
            <div class="lock-info">
                <div class="lock-item">
                    <label>Lock Active</label>
                    <div class="value" id="lock-active">Yes</div>
                </div>
                <div class="lock-item">
                    <label>Locked By</label>
                    <div class="value" id="lock-reason">Signature Mismatch</div>
                </div>
                <div class="lock-item">
                    <label>Time Remaining</label>
                    <div class="value countdown" id="lock-countdown">29:45</div>
                </div>
                <div class="lock-item">
                    <label>Locked At</label>
                    <div class="value" id="lock-time">2024-12-16 15:30:00</div>
                </div>
            </div>
            <div class="lock-controls">
                <button class="btn-danger" id="btn-emergency-unlock" onclick="emergencyUnlock()">
                    üîì Emergency Unlock (Admin Only)
                </button>
                <button class="btn-primary" onclick="viewLockDetails()">View Lock Details</button>
            </div>
        </div>
        
        <!-- Tabs for Different Views -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('incidents')">Active Incidents</div>
            <div class="tab" onclick="switchTab('history')">Incident History</div>
            <div class="tab" onclick="switchTab('forensics')">Forensic Evidence</div>
            <div class="tab" onclick="switchTab('analysis')">Trend Analysis</div>
        </div>
        
        <!-- Active Incidents Tab -->
        <div id="tab-incidents" class="tab-content active">
            <div class="incidents-section">
                <div class="filters">
                    <button class="filter-btn active" onclick="filterIncidents('all')">All</button>
                    <button class="filter-btn" onclick="filterIncidents('CRITICAL')">üî¥ Critical</button>
                    <button class="filter-btn" onclick="filterIncidents('HIGH')">üü† High</button>
                    <button class="filter-btn" onclick="filterIncidents('MEDIUM')">üü° Medium</button>
                    <button class="filter-btn" onclick="filterIncidents('LOW')">üü¢ Low</button>
                </div>
                
                <table class="incidents-table" id="incidents-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Type</th>
                            <th>Severity</th>
                            <th>Status</th>
                            <th>Time</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="incidents-tbody">
                        <tr>
                            <td colspan="6" class="empty-state">
                                <h3>No incidents detected</h3>
                                <p>System is operating normally</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- History Tab -->
        <div id="tab-history" class="tab-content">
            <table class="incidents-table" id="history-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Severity</th>
                        <th>Status</th>
                        <th>Resolved</th>
                        <th>Duration</th>
                    </tr>
                </thead>
                <tbody id="history-tbody">
                    <tr>
                        <td colspan="6" class="empty-state">
                            <h3>No incident history</h3>
                            <p>No incidents have been resolved yet</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Forensics Tab -->
        <div id="tab-forensics" class="tab-content">
            <div class="incidents-section">
                <div class="section-title">üì∏ Forensic Snapshots</div>
                <div id="forensics-container">
                    <div class="empty-state">
                        <h3>No forensic snapshots available</h3>
                        <p>Snapshots are created automatically when incidents occur</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Analysis Tab -->
        <div id="tab-analysis" class="tab-content">
            <div class="incidents-section">
                <div class="section-title">üìä Trend Analysis</div>
                <div id="analysis-container" style="background: white; padding: 30px; border-radius: 8px;">
                    <div class="spinner" style="display: block; margin: 0 auto;"></div>
                    <p style="text-align: center; margin-top: 10px; color: #999;">Loading analysis data...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allIncidents = [];
        let lockCheckInterval;
        
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
            
            // Load tab-specific data
            if (tabName === 'forensics') loadForensics();
            if (tabName === 'analysis') loadAnalysis();
            if (tabName === 'history') loadHistory();
        }
        
        function loadIncidents() {
            fetch('/api/audit-responses/all')
                .then(r => r.json())
                .then(data => {
                    allIncidents = data.incidents || [];
                    renderIncidents();
                    updateStatusCards();
                    checkLockStatus();
                })
                .catch(err => console.error('Failed to load incidents:', err));
        }
        
        function renderIncidents() {
            const tbody = document.getElementById('incidents-tbody');
            
            if (allIncidents.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <h3>No incidents detected</h3>
                            <p>System is operating normally</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = allIncidents.map((incident, idx) => `
                <tr onclick="toggleIncidentDetails(${idx})">
                    <td><code>${incident.id.substring(0, 8)}...</code></td>
                    <td>${incident.anomaly_type}</td>
                    <td><span class="severity-badge severity-${incident.severity.toLowerCase()}">${incident.severity}</span></td>
                    <td><span class="status-badge status-${incident.status.toLowerCase()}">${incident.status}</span></td>
                    <td>${new Date(incident.created_at).toLocaleString()}</td>
                    <td><button class="btn-secondary" onclick="event.stopPropagation(); viewIncident('${incident.id}')">View</button></td>
                </tr>
                <tr class="incident-details" id="detail-${idx}">
                    <td colspan="6">
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Incident ID</label>
                                <div class="value">${incident.id}</div>
                            </div>
                            <div class="detail-item">
                                <label>Anomaly Type</label>
                                <div class="value">${incident.anomaly_type}</div>
                            </div>
                            <div class="detail-item">
                                <label>Severity Score</label>
                                <div class="value">${incident.severity_score || 'N/A'}</div>
                            </div>
                            <div class="detail-item">
                                <label>Detected By</label>
                                <div class="value">${incident.detected_by || 'System'}</div>
                            </div>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                            <strong>Details:</strong>
                            <pre style="font-size: 12px; overflow-x: auto;">${JSON.stringify(incident.details, null, 2)}</pre>
                        </div>
                        <div class="incident-actions">
                            <button class="btn-primary" onclick="markIncidentResolved('${incident.id}')">Mark as Resolved</button>
                            <button class="btn-danger" onclick="escalateIncident('${incident.id}')">Escalate to Admin</button>
                            <button class="btn-secondary" onclick="downloadForensics('${incident.id}')">Download Forensics</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function toggleIncidentDetails(idx) {
            document.getElementById(`detail-${idx}`).classList.toggle('show');
        }
        
        function viewIncident(id) {
            const incident = allIncidents.find(i => i.id === id);
            if (incident) {
                alert(JSON.stringify(incident, null, 2));
            }
        }
        
        function updateStatusCards() {
            const counts = { CRITICAL: 0, HIGH: 0, MEDIUM: 0, LOW: 0 };
            allIncidents.forEach(i => counts[i.severity]++);
            
            document.getElementById('card-critical').querySelector('.value').textContent = counts.CRITICAL;
            document.getElementById('card-high').querySelector('.value').textContent = counts.HIGH;
            document.getElementById('card-medium').querySelector('.value').textContent = counts.MEDIUM;
            document.getElementById('card-low').querySelector('.value').textContent = counts.LOW;
        }
        
        function checkLockStatus() {
            fetch('/api/audit-responses/lock-status')
                .then(r => r.json())
                .then(data => {
                    const lockStatus = document.getElementById('lock-status');
                    const lockAlert = document.getElementById('lock-alert');
                    
                    if (data.is_locked) {
                        lockStatus.style.display = 'block';
                        lockAlert.style.display = 'block';
                        document.getElementById('lock-active').textContent = 'Yes - ACTIVE';
                        document.getElementById('lock-reason').textContent = data.reason || 'Unknown';
                        document.getElementById('lock-time').textContent = new Date(data.locked_at).toLocaleString();
                        startLockCountdown(data.expires_at);
                    } else {
                        lockStatus.style.display = 'none';
                        lockAlert.style.display = 'none';
                    }
                });
        }
        
        function startLockCountdown(expiresAt) {
            if (lockCheckInterval) clearInterval(lockCheckInterval);
            
            lockCheckInterval = setInterval(() => {
                const now = new Date().getTime();
                const expires = new Date(expiresAt).getTime();
                const diff = expires - now;
                
                if (diff <= 0) {
                    document.getElementById('lock-countdown').textContent = 'EXPIRED';
                    clearInterval(lockCheckInterval);
                    return;
                }
                
                const minutes = Math.floor(diff / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                document.getElementById('lock-countdown').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        function emergencyUnlock() {
            if (!confirm('‚ö†Ô∏è EMERGENCY UNLOCK - This will resume operations immediately. Are you sure?')) return;
            
            const password = prompt('Enter admin password to unlock:');
            if (!password) return;
            
            fetch('/api/audit-responses/emergency-unlock', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ admin_password: password })
            })
            .then(r => r.json())
            .then(data => {
                alert(data.message);
                if (data.success) {
                    location.reload();
                }
            });
        }
        
        function markIncidentResolved(id) {
            fetch(`/api/audit-responses/resolve/${id}`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    alert(data.message);
                    loadIncidents();
                });
        }
        
        function escalateIncident(id) {
            fetch(`/api/audit-responses/escalate/${id}`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    alert(data.message);
                    loadIncidents();
                });
        }
        
        function filterIncidents(severity) {
            // This would be implemented with filtering logic
            console.log('Filter by:', severity);
        }
        
        function downloadForensics(id) {
            window.location.href = `/api/audit-responses/forensics/${id}/download`;
        }
        
        function loadHistory() {
            fetch('/api/audit-responses/history')
                .then(r => r.json())
                .then(data => {
                    const tbody = document.getElementById('history-tbody');
                    if (data.history.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><h3>No history</h3></td></tr>';
                    } else {
                        tbody.innerHTML = data.history.map(h => `
                            <tr>
                                <td><code>${h.id.substring(0, 8)}...</code></td>
                                <td>${h.anomaly_type}</td>
                                <td><span class="severity-badge severity-${h.severity.toLowerCase()}">${h.severity}</span></td>
                                <td><span class="status-badge status-${h.status.toLowerCase()}">${h.status}</span></td>
                                <td>${new Date(h.resolved_at).toLocaleString()}</td>
                                <td>${h.duration || 'N/A'}</td>
                            </tr>
                        `).join('');
                    }
                });
        }
        
        function loadForensics() {
            fetch('/api/audit-responses/forensics')
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('forensics-container');
                    if (data.snapshots.length === 0) {
                        container.innerHTML = '<div class="empty-state"><h3>No forensic snapshots</h3></div>';
                    } else {
                        container.innerHTML = `
                            <ul class="snapshot-list">
                                ${data.snapshots.map(s => `
                                    <li class="snapshot-item">
                                        <div>
                                            <strong>${s.incident_id}</strong>
                                            <br>
                                            <span class="snapshot-time">${new Date(s.created_at).toLocaleString()}</span>
                                        </div>
                                        <button class="btn-secondary" onclick="downloadSnapshot('${s.id}')">Download</button>
                                    </li>
                                `).join('')}
                            </ul>
                        `;
                    }
                });
        }
        
        function loadAnalysis() {
            fetch('/api/audit-responses/analysis')
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('analysis-container');
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h3>Incident Trends</h3>
                                <p>Critical: ${data.trend.critical_count} incidents</p>
                                <p>High: ${data.trend.high_count} incidents</p>
                                <p>Average Resolution Time: ${data.trend.avg_resolution_time}h</p>
                            </div>
                            <div>
                                <h3>System Health</h3>
                                <p>Most Common: ${data.trend.most_common_type}</p>
                                <p>Detection Rate: ${data.trend.detection_rate}%</p>
                                <p>False Positive Rate: ${data.trend.false_positive_rate}%</p>
                            </div>
                        </div>
                    `;
                });
        }
        
        function downloadSnapshot(id) {
            window.location.href = `/api/audit-responses/forensics/${id}/download`;
        }
        
        // Load data on page load
        window.addEventListener('load', () => {
            loadIncidents();
            setInterval(loadIncidents, 5000); // Refresh every 5 seconds
        });
    </script>
</body>
</html>
