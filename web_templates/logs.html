{% extends "base.html" %}

{% block title %}Logs - Crypto Transaction Tracker{% endblock %}

{% block extra_css %}
<style>
    .logs-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
    }
    
    .log-card {
        background: white;
        border: 1px solid var(--md-sys-color-surface-variant);
        border-radius: 8px;
        padding: 16px;
        transition: box-shadow 0.2s;
    }
    
    .log-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .log-name {
        font-weight: 500;
        font-size: 1rem;
        margin-bottom: 8px;
        color: var(--md-sys-color-on-surface);
    }
    
    .log-meta {
        display: flex;
        justify-content: space-between;
        color: var(--md-sys-color-on-surface-variant);
        font-size: 0.85rem;
        margin-bottom: 12px;
    }
    
    .log-actions {
        display: flex;
        gap: 8px;
    }
</style>
{% endblock %}

{% block content %}
<h1 style="margin-bottom: 24px;">Application Logs</h1>

<div class="card" style="margin-bottom: 24px;">
    <h2 class="card-title">Bulk Download</h2>
    <p style="margin-bottom: 16px; color: var(--md-sys-color-on-surface-variant);">
        Download all log files at once or get redacted versions for support.
    </p>
    
    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <button class="btn btn-primary" id="btnDownloadAllLogs">
            <span class="material-icons" style="vertical-align: middle;">download</span>
            Download All Logs
        </button>
        <button class="btn btn-secondary" id="btnDownloadRedactedLogs">
            <span class="material-icons" style="vertical-align: middle;">security</span>
            Download Redacted Logs (Safe for Support)
        </button>
    </div>
    
    <div class="alert alert-info" style="margin-top: 16px;">
        <strong>ℹ️ About Redacted Logs:</strong>
        <ul style="margin-left: 20px; margin-top: 8px; line-height: 1.6;">
            <li><strong>What's removed:</strong> Wallet addresses, API keys, secrets, email addresses, IP addresses, usernames, private keys</li>
            <li><strong>What's kept:</strong> Error messages, timestamps, transaction types, operation flows, system information</li>
            <li><strong>Use case:</strong> Safe to share with support teams or when requesting help on forums without exposing your personal data</li>
        </ul>
    </div>
</div>

<div class="card">
    <h2 class="card-title">Individual Log Files</h2>
    <p style="margin-bottom: 16px; color: var(--md-sys-color-on-surface-variant);">
        View and download individual log files.
    </p>
    
    <div id="logsContainer">
        <p>Loading logs...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script nonce="{{ csp_nonce }}">
    async function loadLogs() {
        try {
            const response = await api.get('/api/logs');
            const logs = JSON.parse(response.data);
            
            const container = document.getElementById('logsContainer');
            
            if (logs.length === 0) {
                container.innerHTML = '<p style="color: var(--md-sys-color-on-surface-variant);">No log files found.</p>';
                return;
            }
            
            container.innerHTML = `
                <div class="logs-grid">
                    ${logs.map((log, idx) => `
                        <div class="log-card">
                            <div class="log-name">${log.name}</div>
                            <div class="log-meta">
                                <span>${formatFileSize(log.size)}</span>
                                <span>${formatDate(log.modified)}</span>
                            </div>
                            <div class="log-actions">
                                <button class="btn btn-primary log-download-btn" data-path="${log.path}" data-name="${log.name}">
                                    <span class="material-icons" style="vertical-align: middle; font-size: 18px;">download</span>
                                    Download
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            // Bind download buttons
            container.querySelectorAll('.log-download-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    downloadLog(btn.dataset.path, btn.dataset.name);
                });
            });
        } catch (error) {
            console.error('Error loading logs:', error);
            document.getElementById('logsContainer').innerHTML = 
                '<p style="color: var(--md-sys-color-error);">Failed to load logs: ' + error.message + '</p>';
        }
    }
    
    function downloadLog(path, filename) {
        window.location.href = `/api/logs/download/${encodeURIComponent(path)}`;
    }
    
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    function formatDate(isoString) {
        const date = new Date(isoString);
        return date.toLocaleString();
    }
    
    function downloadAllLogs() {
        window.location.href = '/api/logs/download-all';
    }
    
    function downloadRedactedLogs() {
        window.location.href = '/api/logs/download-redacted';
    }
    
    // Load logs on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadLogs();
        
        document.getElementById('btnDownloadAllLogs').addEventListener('click', downloadAllLogs);
        document.getElementById('btnDownloadRedactedLogs').addEventListener('click', downloadRedactedLogs);
    });
</script>
{% endblock %}
