{% extends "base.html" %}

{% block title %}Reports - Crypto Transaction Tracker{% endblock %}

{% block extra_css %}
<style>
    .year-section {
        margin-bottom: 32px;
    }
    
    .year-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 2px solid var(--md-sys-color-primary);
    }
    
    .year-header h2 {
        margin: 0;
        color: var(--md-sys-color-primary);
    }
    
    .reports-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
    }
    
    .report-card {
        background: white;
        border: 1px solid var(--md-sys-color-surface-variant);
        border-radius: 8px;
        padding: 16px;
        transition: box-shadow 0.2s;
    }
    
    .report-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .report-name {
        font-weight: 500;
        font-size: 1rem;
        margin-bottom: 8px;
        color: var(--md-sys-color-on-surface);
    }
    
    .report-meta {
        display: flex;
        justify-content: space-between;
        color: var(--md-sys-color-on-surface-variant);
        font-size: 0.85rem;
        margin-bottom: 12px;
    }
    
    .report-actions {
        display: flex;
        gap: 8px;
    }
    
    .chart-container {
        margin-bottom: 24px;
        padding: 20px;
        background: white;
        border-radius: 8px;
    }
    
    /* Download Warning Modal Styles */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        cursor: pointer;
    }

    .modal-content {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        padding: 20px;
        border-bottom: 2px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h2 {
        margin: 0;
        color: #d9534f;
        font-size: 20px;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: #999;
    }

    .modal-close:hover {
        color: #333;
    }

    .modal-body {
        padding: 20px;
        flex: 1;
        overflow-y: auto;
    }

    .warning-box {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 4px;
        padding: 16px;
        margin-bottom: 20px;
    }

    .warning-box p {
        margin: 0 0 12px 0;
        font-weight: bold;
        color: #856404;
    }

    .warning-box ul {
        margin: 0;
        padding-left: 20px;
        color: #856404;
    }

    .warning-box li {
        margin-bottom: 8px;
        line-height: 1.5;
    }

    .warning-box ul ul {
        margin-top: 6px;
        font-size: 0.95em;
    }

    .confirmation-section {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 16px;
    }

    .checkbox-label {
        display: flex;
        align-items: flex-start;
        margin-bottom: 12px;
        cursor: pointer;
        user-select: none;
    }

    .checkbox-label:last-child {
        margin-bottom: 0;
    }

    .checkbox-label input[type="checkbox"] {
        margin-right: 10px;
        margin-top: 4px;
        cursor: pointer;
        width: 18px;
        height: 18px;
    }

    .checkbox-label span {
        color: #333;
        line-height: 1.5;
    }

    .modal-footer {
        padding: 16px 20px;
        border-top: 1px solid #f0f0f0;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .modal-footer .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s;
    }

    .modal-footer .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .modal-footer .btn-secondary:hover {
        background: #5a6268;
    }

    .modal-footer .btn-primary {
        background: #007bff;
        color: white;
    }

    .modal-footer .btn-primary:hover:not(:disabled) {
        background: #0056b3;
    }

    .modal-footer .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
        opacity: 0.6;
    }
</style>
{% endblock %}

{% block content %}
<h1 style="margin-bottom: 24px;">Transaction Reports & Downloads</h1>

<div id="warningsDisabledNotice" class="alert alert-danger" style="display: none; margin-bottom: 24px; border: 2px solid #d9534f;">
    <span class="material-icons" style="margin-right: 12px; vertical-align: middle;">warning</span>
    <span><strong>⚠️ CRITICAL REMINDER:</strong> Download warnings are currently DISABLED in your settings. You are STILL required to review every number in these CSV outputs with a qualified tax professional (CPA, tax attorney, or enrolled agent) before filing your taxes. Failure to do so could result in tax penalties. The tool author takes no liability for errors or omissions.</span>
</div>

<div id="updateNotice" class="alert alert-warning" style="display: none; margin-bottom: 24px;">
    <span class="material-icons" style="margin-right: 12px;">info</span>
    <span><strong>New Data Detected:</strong> You have added or modified transactions since the last report generation. Please run the Transaction calculation to update your reports.</span>
</div>

<div class="card">
    <h2 class="card-title">Generate New Reports</h2>
    <p style="margin-bottom: 16px;">Start a new Transaction calculation run to generate updated reports.</p>
    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <button id="runProcessingCalcBtn" class="btn btn-primary">
            <span class="material-icons" style="vertical-align: middle;">play_arrow</span>
            Run Transaction Calculation
        </button>
        <button id="runCascadeBtn" class="btn btn-secondary" style="background-color: #FF9800; color: white;">
            <span class="material-icons" style="vertical-align: middle;">history</span>
            Full Recalculation (Cascade)
        </button>
        <button id="uploadCsvBtn" class="btn btn-secondary">
            <span class="material-icons" style="vertical-align: middle;">upload_file</span>
            Upload CSV
        </button>
    </div>
</div>

<div class="card">
    <h2 class="card-title">Gains & Losses Chart</h2>
    <div id="chartContainer" class="chart-container">
        <canvas id="gainsLossesChart"></canvas>
    </div>
</div>

<div class="card">
    <h2 class="card-title">Available Reports</h2>
    <div id="reportsContainer">
        <p>Loading reports...</p>
    </div>
</div>

<!-- File upload modal -->
<input type="file" id="csvFileInput" accept=".csv" style="display: none;">

<!-- Download Warning Modal -->
<div id="downloadWarningModal" class="modal" style="display: none;">
  <div class="modal-overlay" onclick="closeDownloadWarning()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h2>⚠️ Important: Review Before Downloading</h2>
      <button type="button" class="modal-close" onclick="closeDownloadWarning()">&times;</button>
    </div>
    
    <div class="modal-body">
      <div class="warning-box">
        <p><strong>IMPORTANT DISCLAIMER:</strong></p>
        <ul>
          <li><strong>Do NOT file taxes based solely on these outputs.</strong> They may contain errors.</li>
          <li><strong>You must review every number</strong> in the generated files with a qualified tax professional (CPA, tax attorney, or IRS-enrolled agent).</li>
          <li><strong>Consult a tax professional about:</strong>
            <ul>
              <li>Your specific tax situation and any edge cases</li>
              <li>Whether all transactions were captured</li>
              <li>Cost basis calculations and accuracy</li>
              <li>Wash sale detection and classification</li>
              <li>Income recognition and timing</li>
              <li>Any missing or suspicious data</li>
            </ul>
          </li>
          <li><strong>The author takes no liability</strong> for errors, omissions, or tax penalties resulting from using this tool.</li>
        </ul>
      </div>
      
      <div class="confirmation-section">
        <label class="checkbox-label">
          <input type="checkbox" id="confirmCheckbox" onchange="updateDownloadButton()">
          <span>I understand and will review this with a qualified tax professional before filing</span>
        </label>
        
        <label class="checkbox-label">
          <input type="checkbox" id="consultCheckbox" onchange="updateDownloadButton()">
          <span>I will consult a tax professional for any questions about these results</span>
        </label>
      </div>
    </div>
    
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closeDownloadWarning()">Cancel</button>
      <button type="button" class="btn btn-primary" id="proceedDownloadBtn" onclick="proceedDownload()" disabled>
        I Understand - Proceed with Download
      </button>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js" nonce="{{ csp_nonce }}"></script>
<script nonce="{{ csp_nonce }}">
    let chart = null;
    
    async function loadReports() {
        try {
            const response = await api.get('/api/reports');
            const years = JSON.parse(response.data);
            
            const container = document.getElementById('reportsContainer');
            
            if (years.length === 0) {
                container.innerHTML = '<p style="color: var(--md-sys-color-on-surface-variant);">No reports generated yet. Run Transaction calculation to generate reports.</p>';
                return;
            }
            
            container.innerHTML = years.map(yearData => `
                <div class="year-section">
                    <div class="year-header">
                        <h2>${yearData.year}</h2>
                        <span style="color: var(--md-sys-color-on-surface-variant);">${yearData.reports.length} reports</span>
                    </div>
                    <div class="reports-grid">
                        ${yearData.reports.map(report => `
                            <div class="report-card">
                                <div class="report-name">${report.name}</div>
                                <div class="report-meta">
                                    <span>${formatFileSize(report.size)}</span>
                                    <span>${formatDate(report.modified)}</span>
                                </div>
                                <div class="report-actions">
                                    <button class="btn btn-primary report-download-btn" data-path="${report.path}" data-name="${report.name}">
                                        <span class="material-icons" style="vertical-align: middle; font-size: 18px;">download</span>
                                        Download
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            
        } catch (error) {
            console.error('Error loading reports:', error);
            showAlert('Failed to load reports: ' + error.message, 'error');
        }
    }
    
    async function loadGainsLossesChart() {
        try {
            const response = await api.get('/api/stats');
            const stats = JSON.parse(response.data);
            
            if (!stats.gains_losses) {
                document.getElementById('chartContainer').innerHTML = '<p style="color: var(--md-sys-color-on-surface-variant);">No gains/losses data available. Run Transaction calculation first.</p>';
                return;
            }
            
            const gl = stats.gains_losses;
            
            const ctx = document.getElementById('gainsLossesChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Short-Term Gains', 'Short-Term Losses', 'Long-Term Gains', 'Long-Term Losses'],
                    datasets: [{
                        label: 'USD Value',
                        data: [
                            parseFloat(gl['Short-Term Gains'] || gl['short_term_gains'] || 0),
                            parseFloat(gl['Short-Term Losses'] || gl['short_term_losses'] || 0),
                            parseFloat(gl['Long-Term Gains'] || gl['long_term_gains'] || 0),
                            parseFloat(gl['Long-Term Losses'] || gl['long_term_losses'] || 0)
                        ],
                        backgroundColor: [
                            '#4CAF50',
                            '#F44336',
                            '#2196F3',
                            '#FF9800'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Capital Gains & Losses'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
        } catch (error) {
            console.error('Error loading chart:', error);
        }
    }
    
    let pendingReportPath = null;
    let downloadWarningsEnabled = true;

    function showDownloadWarning(reportPath) {
        pendingReportPath = reportPath;
        
        // If warnings disabled, proceed directly to API call
        if (!downloadWarningsEnabled) {
            proceedDownload();
            return;
        }
        
        // Otherwise show modal
        document.getElementById('downloadWarningModal').style.display = 'flex';
        document.getElementById('confirmCheckbox').checked = false;
        document.getElementById('consultCheckbox').checked = false;
        updateDownloadButton();
    }

    function closeDownloadWarning() {
        document.getElementById('downloadWarningModal').style.display = 'none';
        pendingReportPath = null;
    }

    function updateDownloadButton() {
        const confirmCheckbox = document.getElementById('confirmCheckbox');
        const consultCheckbox = document.getElementById('consultCheckbox');
        const proceedBtn = document.getElementById('proceedDownloadBtn');
        
        proceedBtn.disabled = !(confirmCheckbox.checked && consultCheckbox.checked);
    }

    function proceedDownload() {
        if (!pendingReportPath) {
            showAlert('Error: No report path specified', 'error');
            return;
        }
        
        // If warnings enabled, check checkboxes
        if (downloadWarningsEnabled) {
            const confirmCheckbox = document.getElementById('confirmCheckbox');
            const consultCheckbox = document.getElementById('consultCheckbox');
            
            if (!confirmCheckbox.checked || !consultCheckbox.checked) {
                showAlert('Please confirm both checkboxes before proceeding', 'error');
                return;
            }
        }
        
        // Send confirmation to backend
        fetch('/api/download-warning-acknowledged', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                confirmed: true,
                report_path: pendingReportPath
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Failed to acknowledge warning');
                });
            }
            return response.json();
        })
        .then(data => {
            closeDownloadWarning();
            // Trigger the actual download
            window.location.href = data.download_url;
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error processing download: ' + error.message, 'error');
        });
    }

    // Close modal when pressing Escape
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const modal = document.getElementById('downloadWarningModal');
            if (modal && modal.style.display === 'flex') {
                closeDownloadWarning();
            }
        }
    });

    async function checkDownloadWarningsConfig() {
        try {
            const response = await api.get('/api/download-warnings-config');
            const config = JSON.parse(response.data);
            downloadWarningsEnabled = config.enabled;
            
            // Show/hide persistent warning
            const warningNotice = document.getElementById('warningsDisabledNotice');
            if (!downloadWarningsEnabled) {
                warningNotice.style.display = 'block';
            } else {
                warningNotice.style.display = 'none';
            }
        } catch (error) {
            console.error('Error checking download warnings config:', error);
            // Default to enabled if error
            downloadWarningsEnabled = true;
        }
    }
    
    async function downloadReport(path, filename) {
        try {
            showDownloadWarning(path);
        } catch (error) {
            showAlert('Failed to download report: ' + error.message, 'error');
        }
    }

    function _bindReportDownloads() {
        document.querySelectorAll('.report-download-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                downloadReport(btn.dataset.path, btn.dataset.name);
            });
        });
    }
    
    async function runProcessingCalculation() {
        if (!confirm('Start Transaction calculation? This may take several minutes.')) {
            return;
        }
        
        try {
            const response = await api.post('/api/run', {});
            const result = JSON.parse(response.data);
            showAlert(result.message, 'success');
            
            // Reload reports after a delay
            setTimeout(() => {
                loadReports();
                loadGainsLossesChart();
                checkStatus();
            }, 5000);
        } catch (error) {
            showAlert('Failed to start calculation: ' + error.message, 'error');
        }
    }

    async function runCascadeCalculation() {
        if (!confirm('WARNING: Cascade Recalculation will re-process ALL years starting from your first transaction.\n\nThis will overwrite previous reports and may change your Transaction liability for past years.\n\nAre you sure you want to continue?')) {
            return;
        }
        
        try {
            const response = await api.post('/api/run', { cascade: true });
            const result = JSON.parse(response.data);
            showAlert(result.message + ' (Cascade Mode)', 'success');
            
            // Reload reports after a delay
            setTimeout(() => {
                loadReports();
                loadGainsLossesChart();
                checkStatus();
            }, 5000);
        } catch (error) {
            showAlert('Failed to start cascade calculation: ' + error.message, 'error');
        }
    }
    
    function uploadCSV() {
        document.getElementById('csvFileInput').click();
    }
    
    async function handleFileUpload() {
        const fileInput = document.getElementById('csvFileInput');
        const file = fileInput.files[0];
        
        if (!file) return;
        
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            // Initialize CSRF token
            await api.initCSRF();
            
            const response = await fetch('/api/csv-upload', {
                method: 'POST',
                headers: {
                    'X-CSRF-Token': api.csrfToken,
                    'X-Request-Timestamp': new Date().toISOString()
                },
                body: formData,
                credentials: 'same-origin'
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Upload failed');
            }
            
            const result = await response.json();
            const data = JSON.parse(result.data);
            showAlert(data.message, 'success');
            
            // Clear file input
            fileInput.value = '';
        } catch (error) {
            showAlert('Failed to upload file: ' + error.message, 'error');
        }
    }
    
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    function formatDate(isoString) {
        const date = new Date(isoString);
        return date.toLocaleDateString();
    }
    
    async function checkStatus() {
        try {
            const response = await api.get('/api/status');
            const status = JSON.parse(response.data);
            
            if (status.last_data_change && status.last_run) {
                const dataChange = new Date(status.last_data_change);
                const lastRun = new Date(status.last_run);
                
                if (dataChange > lastRun) {
                    document.getElementById('updateNotice').style.display = 'flex';
                }
            } else if (status.last_data_change && !status.last_run) {
                // Data exists but never run
                document.getElementById('updateNotice').style.display = 'flex';
            }
        } catch (error) {
            console.error('Error checking status:', error);
        }
    }

    // Bind events and load data on page load
    document.addEventListener('DOMContentLoaded', () => {
        const runBtn = document.getElementById('runProcessingCalcBtn');
        if (runBtn) runBtn.addEventListener('click', runProcessingCalculation);
        const cascadeBtn = document.getElementById('runCascadeBtn');
        if (cascadeBtn) cascadeBtn.addEventListener('click', runCascadeCalculation);
        const uploadBtn = document.getElementById('uploadCsvBtn');
        if (uploadBtn) uploadBtn.addEventListener('click', uploadCSV);
        const fileInput = document.getElementById('csvFileInput');
        if (fileInput) fileInput.addEventListener('change', handleFileUpload);

        checkDownloadWarningsConfig();
        loadReports();
        loadGainsLossesChart();
        checkStatus();
        _bindReportDownloads();
    });
</script>
{% endblock %}
