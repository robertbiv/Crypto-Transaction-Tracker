{% extends "base.html" %}

{% block title %}Reports - Crypto Tax Generator{% endblock %}

{% block extra_css %}
<style>
    .year-section {
        margin-bottom: 32px;
    }
    
    .year-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 2px solid var(--md-sys-color-primary);
    }
    
    .year-header h2 {
        margin: 0;
        color: var(--md-sys-color-primary);
    }
    
    .reports-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
    }
    
    .report-card {
        background: white;
        border: 1px solid var(--md-sys-color-surface-variant);
        border-radius: 8px;
        padding: 16px;
        transition: box-shadow 0.2s;
    }
    
    .report-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .report-name {
        font-weight: 500;
        font-size: 1rem;
        margin-bottom: 8px;
        color: var(--md-sys-color-on-surface);
    }
    
    .report-meta {
        display: flex;
        justify-content: space-between;
        color: var(--md-sys-color-on-surface-variant);
        font-size: 0.85rem;
        margin-bottom: 12px;
    }
    
    .report-actions {
        display: flex;
        gap: 8px;
    }
    
    .chart-container {
        margin-bottom: 24px;
        padding: 20px;
        background: white;
        border-radius: 8px;
    }
</style>
{% endblock %}

{% block content %}
<h1 style="margin-bottom: 24px;">Tax Reports & Downloads</h1>

<div id="updateNotice" class="alert alert-warning" style="display: none; margin-bottom: 24px;">
    <span class="material-icons" style="margin-right: 12px;">info</span>
    <span><strong>New Data Detected:</strong> You have added or modified transactions since the last report generation. Please run the tax calculation to update your reports.</span>
</div>

<div class="card">
    <h2 class="card-title">Generate New Reports</h2>
    <p style="margin-bottom: 16px;">Start a new tax calculation run to generate updated reports.</p>
    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <button class="btn btn-primary" onclick="runTaxCalculation()">
            <span class="material-icons" style="vertical-align: middle;">play_arrow</span>
            Run Tax Calculation
        </button>
        <button class="btn btn-secondary" onclick="runCascadeCalculation()" style="background-color: #FF9800; color: white;">
            <span class="material-icons" style="vertical-align: middle;">history</span>
            Full Recalculation (Cascade)
        </button>
        <button class="btn btn-secondary" onclick="uploadCSV()">
            <span class="material-icons" style="vertical-align: middle;">upload_file</span>
            Upload CSV
        </button>
    </div>
</div>

<div class="card">
    <h2 class="card-title">Gains & Losses Chart</h2>
    <div id="chartContainer" class="chart-container">
        <canvas id="gainsLossesChart"></canvas>
    </div>
</div>

<div class="card">
    <h2 class="card-title">Available Reports</h2>
    <div id="reportsContainer">
        <p>Loading reports...</p>
    </div>
</div>

<!-- File upload modal -->
<input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleFileUpload()">
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js" nonce="{{ csp_nonce }}"></script>
<script nonce="{{ csp_nonce }}">
    let chart = null;
    
    async function loadReports() {
        try {
            const response = await api.get('/api/reports');
            const years = JSON.parse(response.data);
            
            const container = document.getElementById('reportsContainer');
            
            if (years.length === 0) {
                container.innerHTML = '<p style="color: var(--md-sys-color-on-surface-variant);">No reports generated yet. Run tax calculation to generate reports.</p>';
                return;
            }
            
            container.innerHTML = years.map(yearData => `
                <div class="year-section">
                    <div class="year-header">
                        <h2>${yearData.year}</h2>
                        <span style="color: var(--md-sys-color-on-surface-variant);">${yearData.reports.length} reports</span>
                    </div>
                    <div class="reports-grid">
                        ${yearData.reports.map(report => `
                            <div class="report-card">
                                <div class="report-name">${report.name}</div>
                                <div class="report-meta">
                                    <span>${formatFileSize(report.size)}</span>
                                    <span>${formatDate(report.modified)}</span>
                                </div>
                                <div class="report-actions">
                                    <button class="btn btn-primary" onclick="downloadReport('${report.path}', '${report.name}')">
                                        <span class="material-icons" style="vertical-align: middle; font-size: 18px;">download</span>
                                        Download
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            
        } catch (error) {
            console.error('Error loading reports:', error);
            showAlert('Failed to load reports: ' + error.message, 'error');
        }
    }
    
    async function loadGainsLossesChart() {
        try {
            const response = await api.get('/api/stats');
            const stats = JSON.parse(response.data);
            
            if (!stats.gains_losses) {
                document.getElementById('chartContainer').innerHTML = '<p style="color: var(--md-sys-color-on-surface-variant);">No gains/losses data available. Run tax calculation first.</p>';
                return;
            }
            
            const gl = stats.gains_losses;
            
            const ctx = document.getElementById('gainsLossesChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Short-Term Gains', 'Short-Term Losses', 'Long-Term Gains', 'Long-Term Losses'],
                    datasets: [{
                        label: 'USD Value',
                        data: [
                            parseFloat(gl['Short-Term Gains'] || gl['short_term_gains'] || 0),
                            parseFloat(gl['Short-Term Losses'] || gl['short_term_losses'] || 0),
                            parseFloat(gl['Long-Term Gains'] || gl['long_term_gains'] || 0),
                            parseFloat(gl['Long-Term Losses'] || gl['long_term_losses'] || 0)
                        ],
                        backgroundColor: [
                            '#4CAF50',
                            '#F44336',
                            '#2196F3',
                            '#FF9800'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Capital Gains & Losses'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
        } catch (error) {
            console.error('Error loading chart:', error);
        }
    }
    
    async function downloadReport(path, filename) {
        try {
            window.location.href = `/api/reports/download/${encodeURIComponent(path)}`;
        } catch (error) {
            showAlert('Failed to download report: ' + error.message, 'error');
        }
    }
    
    async function runTaxCalculation() {
        if (!confirm('Start tax calculation? This may take several minutes.')) {
            return;
        }
        
        try {
            const response = await api.post('/api/run', {});
            const result = JSON.parse(response.data);
            showAlert(result.message, 'success');
            
            // Reload reports after a delay
            setTimeout(() => {
                loadReports();
                loadGainsLossesChart();
                checkStatus();
            }, 5000);
        } catch (error) {
            showAlert('Failed to start calculation: ' + error.message, 'error');
        }
    }

    async function runCascadeCalculation() {
        if (!confirm('WARNING: Cascade Recalculation will re-process ALL years starting from your first transaction.\n\nThis will overwrite previous reports and may change your tax liability for past years.\n\nAre you sure you want to continue?')) {
            return;
        }
        
        try {
            const response = await api.post('/api/run', { cascade: true });
            const result = JSON.parse(response.data);
            showAlert(result.message + ' (Cascade Mode)', 'success');
            
            // Reload reports after a delay
            setTimeout(() => {
                loadReports();
                loadGainsLossesChart();
                checkStatus();
            }, 5000);
        } catch (error) {
            showAlert('Failed to start cascade calculation: ' + error.message, 'error');
        }
    }
    
    function uploadCSV() {
        document.getElementById('csvFileInput').click();
    }
    
    async function handleFileUpload() {
        const fileInput = document.getElementById('csvFileInput');
        const file = fileInput.files[0];
        
        if (!file) return;
        
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            // Initialize CSRF token
            await api.initCSRF();
            
            const response = await fetch('/api/csv-upload', {
                method: 'POST',
                headers: {
                    'X-CSRF-Token': api.csrfToken,
                    'X-Request-Timestamp': new Date().toISOString()
                },
                body: formData,
                credentials: 'same-origin'
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Upload failed');
            }
            
            const result = await response.json();
            const data = JSON.parse(result.data);
            showAlert(data.message, 'success');
            
            // Clear file input
            fileInput.value = '';
        } catch (error) {
            showAlert('Failed to upload file: ' + error.message, 'error');
        }
    }
    
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    function formatDate(isoString) {
        const date = new Date(isoString);
        return date.toLocaleDateString();
    }
    
    async function checkStatus() {
        try {
            const response = await api.get('/api/status');
            const status = JSON.parse(response.data);
            
            if (status.last_data_change && status.last_run) {
                const dataChange = new Date(status.last_data_change);
                const lastRun = new Date(status.last_run);
                
                if (dataChange > lastRun) {
                    document.getElementById('updateNotice').style.display = 'flex';
                }
            } else if (status.last_data_change && !status.last_run) {
                // Data exists but never run
                document.getElementById('updateNotice').style.display = 'flex';
            }
        } catch (error) {
            console.error('Error checking status:', error);
        }
    }

    // Load data on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadReports();
        loadGainsLossesChart();
        checkStatus();
    });
</script>
{% endblock %}
